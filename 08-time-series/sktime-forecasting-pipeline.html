
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Sktime: Forecasting Pipeline</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Darts: Deep Forecasting" href="darts-deep-forecasting.html" />
    <link rel="prev" title="Prophet: Forecasting Algorithms" href="prophet-forecasting-algorithms.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.svg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../util/intro.html">
                    Data Science
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01-python-programing/_intro.html">
   <b>
    1. Python Programing
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-basic-concepts.html">
     Python: Basic Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-data-types.html">
     Python: Data Types
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-data-containers.html">
     Python: Data Containers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-functions-objects.html">
     Python: Functions and Objects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-algorithms.html">
     (w) Python: Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-external-sources.html">
     Python: External Sources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/selenium-web-scraping.html">
     Selenium: Web Scraping
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02-mathematics/_intro.html">
   <b>
    2. Mathematics
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-linear-algebra.html">
     NumPy: Linear Algebra
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/sympy-calculus.html">
     SymPy: Calculus
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-probability.html">
     NumPy: Probability
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-statistics.html">
     NumPy: Statistics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/scipy-hypothesis-testing.html">
     SciPy: Hypothesis Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-applied-mathematics.html">
     (w) NumPy: Applied Mathematics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/networkx-network-analysis.html">
     (w) NetworkX: Network Analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../03-data-manipulation/_intro.html">
   <b>
    3. Data Manipulation
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/numpy-arrays.html">
     NumPy: Arrays
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/pandas-data-exploratory.html">
     Pandas: Data Exploratory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/pandas-data-cleaning.html">
     Pandas: Data Cleaning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/pandas-data-transformation.html">
     Pandas: Data Transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/janitor-pandas-extensions.html">
     Janitor: Pandas Extensions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../04-big-data/_intro.html">
   <b>
    4. Big Data
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/hiveql-data-manipulation.html">
     HiveQL: Data Manipulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/pyspark-data-exploratory.html">
     PySpark: Data Exploratory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/pyspark-data-cleaning.html">
     PySpark: Data Cleaning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/pyspark-data-transformation.html">
     PySpark: Data Transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/dask-parallelized-pandas.html">
     Dask: Parallelized Pandas
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../05-data-visualization/_intro.html">
   <b>
    5. Data Visualization
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../05-data-visualization/matplotlib-graph-construction.html">
     Matplotlib: Graph Construction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05-data-visualization/seaborn-statistical-visualization.html">
     Seaborn: Statistical Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05-data-visualization/plotly-interactive-visualization.html">
     Plotly: Interactive Visualization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../06-machine-learning/_intro.html">
   <b>
    6. Machine Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../06-machine-learning/sklearn-machine-learning.html">
     Sklearn: Machine Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06-machine-learning/sklearn-classification.html">
     Sklearn: Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06-machine-learning/sklearn-regression.html">
     Sklearn: Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06-machine-learning/sklearn-feature-engineering.html">
     Featuretools: Feature Engineering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06-machine-learning/lenskit-recommendation.html">
     Lenskit: Recommendation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06-machine-learning/pyspark-machine-learning.html">
     PySpark: Machine Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../07-tabular-learning/_intro.html">
   <b>
    7. Tabular Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/sklearn-ensemble-learning.html">
     Sklearn: Ensemble Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/xgboost-tree-boosting.html">
     XGBoost: Tree Boosting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/ray-hyperparameter-optimization.html">
     Ray: Hyperparam Optimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/shap-model-interpretation.html">
     Shap: Model Interpretation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/imblearn-targeted-modeling.html">
     Imblearn: Targeted Modeling
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="_intro.html">
   <b>
    8. Time Series
   </b>
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="statsmodels-temporal-analysis.html">
     Statsmodels: Temporal Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="prophet-forecasting-algorithms.html">
     Prophet: Forecasting Algorithms
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Sktime: Forecasting Pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="darts-deep-forecasting.html">
     Darts: Deep Forecasting
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../09-unsupervised-learning/_intro.html">
   <b>
    9. Unsupervised Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/mlxtend-association-rules.html">
     (w) MLxtend: Association Rules
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/sklearn-clustering.html">
     Sklearn: Clustering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/sklearn-dimensional-reduction.html">
     Sklearn: Dimensional Reduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/pyod-anomaly-detection.html">
     PyOD: Anomaly Detection
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../10-deep-learning/_intro.html">
   <b>
    10. Deep Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/gensim-text-mining.html">
     Gensim: Text Mining
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/opencv-image-processing.html">
     (w) OpenCV: Image Processing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/numpy-gradient-descent.html">
     Python: Gradient Descent
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/keras-multilayer-perceptron.html">
     Keras: Multilayer Perceptron
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/keras-recurrent-networks.html">
     Keras: Recurrent Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/keras-convolutional-networks.html">
     (w) Keras: Convolutional Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/pytorch-deep-learning.html">
     PyTorch: Deep Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/transformers-transfer-learning.html">
     (w) Transformers: Transfer Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../11-r-programing/_intro.html">
   <b>
    11. R Programing
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/r-basic-concepts.html">
     R: Basic Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/r-data-structures.html">
     R: Data Structures
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/tidyverse-data-wrangling.html">
     Tidyverse: Data Wrangling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/dplyr-data-cleaning.html">
     Dplyr: Data Cleaning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/ggplot-data-visualization.html">
     Ggplot: Data Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/r-statistics.html">
     R: Statistics
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/hungpq7/tabular-book/master?urlpath=lab/tree/08-time-series/sktime-forecasting-pipeline.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/hungpq7/tabular-book/blob/master/08-time-series/sktime-forecasting-pipeline.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/hungpq7/tabular-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/08-time-series/sktime-forecasting-pipeline.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecasting-interface">
   1. Forecasting interface
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-workflow">
     1.1. Basic workflow
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#input-format">
       Input format
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#forecasters">
       Forecasters
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#forecasting-horizon">
       Forecasting horizon
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#update-and-predict">
       Update and predict
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#probabilistic-prediction">
       Probabilistic prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exogeneous-variables">
       Exogeneous variables
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecasting-reduction">
     1.2. Forecasting reduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#recursive-strategy">
       Recursive strategy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#direct-strategy">
       Direct strategy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hybrid-strategy">
       Hybrid strategy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multivariate-reducer">
       Multivariate reducer
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecasting-validation">
   2. Forecasting validation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scoring-metrics">
     2.1. Scoring metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#baseline-forecasters">
       Baseline forecasters
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#difference-error">
       Difference error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#percentage-error">
       Percentage error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#relative-error">
       Relative error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scaled-error">
       Scaled error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#implementation">
       Implementation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backtesting">
     2.2. Backtesting
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cross-validation">
       Cross validation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pipeline">
       Pipeline
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hyperparameter-tuning">
       Hyperparameter tuning
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resources">
   Resources
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Sktime: Forecasting Pipeline</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecasting-interface">
   1. Forecasting interface
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-workflow">
     1.1. Basic workflow
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#input-format">
       Input format
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#forecasters">
       Forecasters
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#forecasting-horizon">
       Forecasting horizon
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#update-and-predict">
       Update and predict
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#probabilistic-prediction">
       Probabilistic prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exogeneous-variables">
       Exogeneous variables
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecasting-reduction">
     1.2. Forecasting reduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#recursive-strategy">
       Recursive strategy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#direct-strategy">
       Direct strategy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hybrid-strategy">
       Hybrid strategy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multivariate-reducer">
       Multivariate reducer
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecasting-validation">
   2. Forecasting validation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scoring-metrics">
     2.1. Scoring metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#baseline-forecasters">
       Baseline forecasters
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#difference-error">
       Difference error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#percentage-error">
       Percentage error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#relative-error">
       Relative error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scaled-error">
       Scaled error
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#implementation">
       Implementation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backtesting">
     2.2. Backtesting
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cross-validation">
       Cross validation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pipeline">
       Pipeline
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hyperparameter-tuning">
       Hyperparameter tuning
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resources">
   Resources
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="sktime-forecasting-pipeline">
<h1>Sktime: Forecasting Pipeline<a class="headerlink" href="#sktime-forecasting-pipeline" title="Permalink to this headline">#</a></h1>
<p>The famous ARIMA model is basically a Linear Regression model on a time series’ own lags. So what if we replace the simple Linear Regression with a state-of-the-art tabular learning algorithm? This (known under the term <em>reduction</em>) is one example of useful features in <a class="reference external" href="https://www.sktime.net/en/stable/index.html">Sktime</a>. In this topic, we are going to use this library to implement a lot of forecasting tasks such as reduction, forecasting, backtesting and evaluation, in an unified way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">sspipe</span> <span class="kn">import</span> <span class="n">p</span><span class="p">,</span> <span class="n">px</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">janitor</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sktime.forecasting.base</span> <span class="kn">import</span> <span class="n">ForecastingHorizon</span> <span class="k">as</span> <span class="n">FH</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.arima</span> <span class="kn">import</span> <span class="n">AutoARIMA</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.ets</span> <span class="kn">import</span> <span class="n">AutoETS</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.compose</span> <span class="kn">import</span> <span class="n">make_reduction</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.conformal</span> <span class="kn">import</span> <span class="n">ConformalIntervals</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.naive</span> <span class="kn">import</span> <span class="n">NaiveVariance</span>

<span class="kn">from</span> <span class="nn">sktime.transformations.series.lag</span> <span class="kn">import</span> <span class="n">Lag</span>
<span class="kn">from</span> <span class="nn">sktime.utils.plotting</span> <span class="kn">import</span> <span class="n">plot_series</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.compose</span> <span class="kn">import</span> <span class="n">MultiplexForecaster</span><span class="p">,</span> <span class="n">TransformedTargetForecaster</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.model_selection</span> <span class="kn">import</span> <span class="n">ExpandingWindowSplitter</span><span class="p">,</span> <span class="n">SlidingWindowSplitter</span><span class="p">,</span> <span class="n">CutoffSplitter</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.model_selection</span> <span class="kn">import</span> <span class="n">ForecastingRandomizedSearchCV</span><span class="p">,</span> <span class="n">ForecastingGridSearchCV</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.model_selection</span> <span class="kn">import</span> <span class="n">temporal_train_test_split</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.model_evaluation</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">sktime.performance_metrics.forecasting</span> <span class="kn">import</span> <span class="n">MeanAbsolutePercentageError</span> <span class="k">as</span> <span class="n">MAPE</span>
<span class="kn">from</span> <span class="nn">sktime.performance_metrics.forecasting</span> <span class="kn">import</span> <span class="n">MeanAbsoluteScaledError</span> <span class="k">as</span> <span class="n">MASE</span>
<span class="kn">from</span> <span class="nn">sktime.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sktime.transformations.series.detrend</span> <span class="kn">import</span> <span class="n">Detrender</span><span class="p">,</span> <span class="n">Deseasonalizer</span>
<span class="kn">from</span> <span class="nn">sktime.transformations.series.difference</span> <span class="kn">import</span> <span class="n">Differencer</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.trend</span> <span class="kn">import</span> <span class="n">PolynomialTrendForecaster</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.naive</span> <span class="kn">import</span> <span class="n">NaiveVariance</span>

<span class="kn">from</span> <span class="nn">skforecast.ForecasterAutoreg</span> <span class="kn">import</span> <span class="n">ForecasterAutoreg</span>
<span class="kn">from</span> <span class="nn">skforecast.ForecasterAutoregCustom</span> <span class="kn">import</span> <span class="n">ForecasterAutoregCustom</span>
<span class="kn">from</span> <span class="nn">skforecast.model_selection</span> <span class="kn">import</span> <span class="n">grid_search_forecaster</span><span class="p">,</span> <span class="n">backtesting_forecaster</span>
<span class="kn">from</span> <span class="nn">skforecast.ForecasterAutoregMultiSeries</span> <span class="kn">import</span> <span class="n">ForecasterAutoregMultiSeries</span>

<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>
<span class="kn">from</span> <span class="nn">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMRegressor</span>
<span class="kn">from</span> <span class="nn">catboost</span> <span class="kn">import</span> <span class="n">CatBoostRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">([</span><span class="s1">&#39;seaborn&#39;</span><span class="p">,</span> <span class="s1">&#39;seaborn-whitegrid&#39;</span><span class="p">])</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<section id="forecasting-interface">
<h2>1. Forecasting interface<a class="headerlink" href="#forecasting-interface" title="Permalink to this headline">#</a></h2>
<section id="basic-workflow">
<h3>1.1. Basic workflow<a class="headerlink" href="#basic-workflow" title="Permalink to this headline">#</a></h3>
<section id="input-format">
<h4>Input format<a class="headerlink" href="#input-format" title="Permalink to this headline">#</a></h4>
<p>The appropriate format of input data for Sktime is a Pandas Series or DataFrame with <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DatetimeIndex.html"><code class="docutils literal notranslate"><span class="pre">DatetimeIndex</span></code></a> and <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.PeriodIndex.html"><code class="docutils literal notranslate"><span class="pre">PeriodIndex</span></code></a>. There are different date and time <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects">frequencies</a> available, but in this section we will demonstrate with a practical use case: business day frequency. For non-time-series sequential data, Sktime also accepts integer index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfQty</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/weekly_quantity.csv&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;date = date.astype(&#39;datetime64&#39;)&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>
    <span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">dfQty</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-06-26</th>
      <td>58.07</td>
    </tr>
    <tr>
      <th>2015-06-29</th>
      <td>59.83</td>
    </tr>
    <tr>
      <th>2015-06-30</th>
      <td>47.84</td>
    </tr>
    <tr>
      <th>2015-07-01</th>
      <td>52.20</td>
    </tr>
    <tr>
      <th>2015-07-02</th>
      <td>44.57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="forecasters">
<h4>Forecasters<a class="headerlink" href="#forecasters" title="Permalink to this headline">#</a></h4>
<p>A pain point occurs in forecasting tasks is that different Python packages such as Statsmodels, PmdArima and Prophet use different fit and predict syntaxes. Sktime serves the role of an unified framework that wraps forecasting models so that Data Scientists can try different forecasters with ease. Sktime supports all popular models, some with an automated version:
<a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.arima.AutoARIMA.html"><code class="docutils literal notranslate"><span class="pre">AutoARIMA</span></code></a>,
<a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.ets.AutoETS.html"><code class="docutils literal notranslate"><span class="pre">AutoETS</span></code></a>,
<a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.tbats.TBATS.html"><code class="docutils literal notranslate"><span class="pre">TBATS</span></code></a>, and
<a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.fbprophet.Prophet.html"><code class="docutils literal notranslate"><span class="pre">Prophet</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoARIMA</span><span class="p">(</span><span class="n">sp</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfQty</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-3 {color: black;background-color: white;}#sk-container-id-3 pre{padding: 0;}#sk-container-id-3 div.sk-toggleable {background-color: white;}#sk-container-id-3 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-3 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-3 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-3 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-3 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-3 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-3 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-3 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-3 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-3 div.sk-item {position: relative;z-index: 1;}#sk-container-id-3 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-3 div.sk-item::before, #sk-container-id-3 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-3 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-3 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-3 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-3 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-3 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-3 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-3 div.sk-label-container {text-align: center;}#sk-container-id-3 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-3 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AutoARIMA(sp=5)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox" checked><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">AutoARIMA</label><div class="sk-toggleable__content"><pre>AutoARIMA(sp=5)</pre></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">cutoff</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Period(&#39;2015-07-02&#39;, &#39;B&#39;)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Once the model is fitted, the last observed value is call the <em>offset</em>, indexed 0. It can be thought as the <em>now</em> state of the time series.</p></li>
<li><p>We can either request future forecasts (<em>out-of-sample forecasting</em>) with the indices start from 1, or request historical fitted values (<em>in-sample prediction</em>) with negative indices. However, some models will return NA for in-sample prediction.</p></li>
</ul>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fh</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-01</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-07-02</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-07-03</th>
      <td>45.301294</td>
    </tr>
    <tr>
      <th>2015-07-06</th>
      <td>53.462003</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="forecasting-horizon">
<h4>Forecasting horizon<a class="headerlink" href="#forecasting-horizon" title="Permalink to this headline">#</a></h4>
<p>The most simple way to request forecasts is using integer indices as above, but sometimes, we need a more pwerful tool. Sktime has a <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.base.ForecastingHorizon.html"><code class="docutils literal notranslate"><span class="pre">ForecastingHorizon</span></code></a> class allowing us to specifiy either relative or absolute horizon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fhRel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">FH</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fhRel</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fhRel</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ForecastingHorizon([-1, 0, 1, 2], dtype=&#39;int64&#39;, is_relative=True)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-01</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-07-02</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-07-03</th>
      <td>45.301294</td>
    </tr>
    <tr>
      <th>2015-07-06</th>
      <td>53.462003</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fhAbs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="s1">&#39;2015-07-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-07-06&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">FH</span><span class="p">,</span> <span class="n">is_relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fhAbs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-01</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-07-02</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-07-03</th>
      <td>45.301294</td>
    </tr>
    <tr>
      <th>2015-07-06</th>
      <td>53.462003</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2015-07-02&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="n">fhRel</span><span class="o">.</span><span class="n">to_absolute</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">display</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ForecastingHorizon([&#39;2015-07-01&#39;, &#39;2015-07-02&#39;, &#39;2015-07-03&#39;, &#39;2015-07-06&#39;], dtype=&#39;period[B]&#39;, is_relative=False)
</pre></div>
</div>
</div>
</div>
</section>
<section id="update-and-predict">
<h4>Update and predict<a class="headerlink" href="#update-and-predict" title="Permalink to this headline">#</a></h4>
<p>We have already known forecasting for far future points is not very accurate, as forecasting errors keep stacking up. For example, if we have daily data, then the forecast for this day next month <span class="math notranslate nohighlight">\(\hat{y}_{t+30|t}\)</span> is not likely to have high quality, no matter how strong the algorithm we are using is. In this case, the approach to solve the problem is more important. A simple but good solution is re-training the model more frequently, like weekly or even daily. This strategy makes the cutoff closer to the query point: <span class="math notranslate nohighlight">\(\hat{y}_{t+7|t}\)</span> (weekly) and <span class="math notranslate nohighlight">\(\hat{y}_{t+1|t}\)</span> (daily).</p>
<p>The downside of frequent re-training is computation cost. Sktime offers a solution with lower training time but does not hurt the quality very much, that is updating. When calling the <code class="docutils literal notranslate"><span class="pre">update()</span></code> method, the fitted model ingests new data and updates the cutoff to the last observed point. Let’s see the behaviour of this method in action.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoARIMA</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfQty</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">cutoff</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Period(&#39;2015-06-25&#39;, &#39;B&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># after updating new 5 observations, the cutoff moves</span>
<span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dfQty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
<span class="n">model</span><span class="o">.</span><span class="n">cutoff</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Period(&#39;2015-07-02&#39;, &#39;B&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fh</span> <span class="o">=</span> <span class="n">FH</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-03</th>
      <td>50.533391</td>
    </tr>
    <tr>
      <th>2015-07-06</th>
      <td>53.435979</td>
    </tr>
    <tr>
      <th>2015-07-07</th>
      <td>52.105592</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="probabilistic-prediction">
<h4>Probabilistic prediction<a class="headerlink" href="#probabilistic-prediction" title="Permalink to this headline">#</a></h4>
<p>Some Sktime forecasters have the ability to perform probabilistic prediction. Two common options are confidence interval (the user specifies a coverage) and distribution quantiles (the user specifies quantiles). I highly recommend using
<code class="docutils literal notranslate"><span class="pre">predict_quantiles()</span></code>
because it can cover both
<code class="docutils literal notranslate"><span class="pre">predict()</span></code> and <code class="docutils literal notranslate"><span class="pre">predict_interval()</span></code>.
For forecasters who don’t support probabilistic prediction, Sktime supports some <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/forecasting.html#prediction-intervals">wrappers</a> to enable this feature without affecting forecasting results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict_interval</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">Coverage</th>
    </tr>
    <tr>
      <th></th>
      <th colspan="2" halign="left">0.9</th>
    </tr>
    <tr>
      <th></th>
      <th>lower</th>
      <th>upper</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-03</th>
      <td>34.881345</td>
      <td>66.185437</td>
    </tr>
    <tr>
      <th>2015-07-06</th>
      <td>37.330719</td>
      <td>69.541240</td>
    </tr>
    <tr>
      <th>2015-07-07</th>
      <td>35.862179</td>
      <td>68.349005</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict_quantiles</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="5" halign="left">Quantiles</th>
    </tr>
    <tr>
      <th></th>
      <th>0.05</th>
      <th>0.10</th>
      <th>0.50</th>
      <th>0.90</th>
      <th>0.95</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-03</th>
      <td>34.881345</td>
      <td>38.338444</td>
      <td>50.533391</td>
      <td>62.728339</td>
      <td>66.185437</td>
    </tr>
    <tr>
      <th>2015-07-06</th>
      <td>37.330719</td>
      <td>40.887919</td>
      <td>53.435979</td>
      <td>65.984039</td>
      <td>69.541240</td>
    </tr>
    <tr>
      <th>2015-07-07</th>
      <td>35.862179</td>
      <td>39.449893</td>
      <td>52.105592</td>
      <td>64.761290</td>
      <td>68.349005</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="exogeneous-variables">
<h4>Exogeneous variables<a class="headerlink" href="#exogeneous-variables" title="Permalink to this headline">#</a></h4>
<p>Traditional statistical models, especially SARIMAX, have considered independent variables that potentially have a strong relationship with our time series. In terms of forecasting, the time series we want to make forecasts is called the <em>endogeneous</em> variable <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> and other independent time series are called <em>exogeneous</em> variables <span class="math notranslate nohighlight">\(\mathbf{x}_1,\mathbf{x}_2,\ldots\)</span>. When exogeneous variables are included in the forecaster, then the model becomes: <span class="math notranslate nohighlight">\(f:\mathbf{y}_{t-1},\mathbf{y}_{t-2},\ldots\mathbf{x}_1,\mathbf{x}_2,\ldots\mapsto\mathbf{y}\)</span>.</p>
<p>However, in the inference phase, it requres values of the exogeneous variables at future time steps that we are requesting forecast. This makes only special variables with appointed time (such as holidays and special events) a viable option. There is a workaround solution to involve economical data (which is much more useful), which is using their lags. For example, to forecast a variable <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> for the next 7 days, we can use <span class="math notranslate nohighlight">\(\mathbf{x}_{t-7}\)</span> for training and leave <span class="math notranslate nohighlight">\(7\)</span> latest values of <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> for inference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfTemp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/air_quality.csv&#39;</span><span class="p">)</span>
<span class="n">dfTemp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">dfTemp</span>
    <span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">select_columns</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;*humidity&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2005-01-15&#39;</span><span class="p">:</span> <span class="s1">&#39;2005-03-15&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">dfTemp</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
      <th>rel_humidity</th>
      <th>abs_humidity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-03-15 19:00:00</th>
      <td>18.0</td>
      <td>36.0</td>
      <td>0.7345</td>
    </tr>
    <tr>
      <th>2005-03-15 20:00:00</th>
      <td>16.4</td>
      <td>41.9</td>
      <td>0.7759</td>
    </tr>
    <tr>
      <th>2005-03-15 21:00:00</th>
      <td>14.9</td>
      <td>47.6</td>
      <td>0.8003</td>
    </tr>
    <tr>
      <th>2005-03-15 22:00:00</th>
      <td>13.8</td>
      <td>49.6</td>
      <td>0.7793</td>
    </tr>
    <tr>
      <th>2005-03-15 23:00:00</th>
      <td>13.2</td>
      <td>51.6</td>
      <td>0.7765</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nTest</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">dfTemp</span><span class="o">.</span><span class="n">select_columns</span><span class="p">(</span><span class="s1">&#39;*humidity&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Lag</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="n">nTest</span><span class="p">,</span> <span class="n">index_out</span><span class="o">=</span><span class="s1">&#39;shift&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># 16/01 to 16/03</span>
<span class="n">xTrain</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">nTest</span><span class="p">]</span> <span class="c1"># 16/01 to 15/03</span>
<span class="n">xTest</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">nTest</span><span class="p">:]</span> <span class="c1"># 16/03</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">dfTemp</span><span class="o">.</span><span class="n">select_columns</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span>
<span class="n">yTrain</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">nTest</span><span class="p">:]</span> <span class="c1"># 16/01 to 15/03</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoARIMA</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">yTrain</span><span class="p">,</span> <span class="n">xTrain</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/anaconda3/lib/python3.8/site-packages/statsmodels/base/model.py:604: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  warnings.warn(&quot;Maximum Likelihood optimization failed to &quot;
</pre></div>
</div>
<div class="output text_html"><style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AutoARIMA()</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">AutoARIMA</label><div class="sk-toggleable__content"><pre>AutoARIMA()</pre></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nForecast</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">yPred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">xTest</span><span class="p">)</span>
<span class="n">yPred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-03-16 00:00:00</th>
      <td>12.424923</td>
    </tr>
    <tr>
      <th>2005-03-16 01:00:00</th>
      <td>12.301092</td>
    </tr>
    <tr>
      <th>2005-03-16 02:00:00</th>
      <td>11.337493</td>
    </tr>
    <tr>
      <th>2005-03-16 21:00:00</th>
      <td>6.075261</td>
    </tr>
    <tr>
      <th>2005-03-16 22:00:00</th>
      <td>5.596284</td>
    </tr>
    <tr>
      <th>2005-03-16 23:00:00</th>
      <td>5.127052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="forecasting-reduction">
<h3>1.2. Forecasting reduction<a class="headerlink" href="#forecasting-reduction" title="Permalink to this headline">#</a></h3>
<p>In order to reduce a forecasting problem to a regression problem, we need to re-arrange the time series into a table so that itself (<span class="math notranslate nohighlight">\(\mathbf{y}_t\)</span>) becomes the label and its lags (<span class="math notranslate nohighlight">\(\mathbf{y}_{t-1},\mathbf{y}_{t-2},\dots\)</span>) become the features. There are three approaches to make prediction to multiple future time steps: recursive reduction, direct reduction and a hybrid between them, implemented in a single function, <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.compose.make_reduction.html"><code class="docutils literal notranslate"><span class="pre">make_reduction()</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfTemp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/air_quality.csv&#39;</span><span class="p">)</span>
<span class="n">dfTemp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">dfTemp</span>
    <span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">select_columns</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">also</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
    <span class="c1"># .to_period(&#39;h&#39;)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9352</th>
      <td>2005-04-04 10:00:00</td>
      <td>21.9</td>
    </tr>
    <tr>
      <th>9353</th>
      <td>2005-04-04 11:00:00</td>
      <td>24.3</td>
    </tr>
    <tr>
      <th>9354</th>
      <td>2005-04-04 12:00:00</td>
      <td>26.9</td>
    </tr>
    <tr>
      <th>9355</th>
      <td>2005-04-04 13:00:00</td>
      <td>28.3</td>
    </tr>
    <tr>
      <th>9356</th>
      <td>2005-04-04 14:00:00</td>
      <td>28.5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfQty</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/weekly_quantity.csv&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;date = date.astype(&#39;datetime64&#39;)&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>
    <span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">dfQty</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-06-28</th>
      <td>81.97</td>
    </tr>
    <tr>
      <th>2015-06-29</th>
      <td>59.83</td>
    </tr>
    <tr>
      <th>2015-06-30</th>
      <td>47.84</td>
    </tr>
    <tr>
      <th>2015-07-01</th>
      <td>52.20</td>
    </tr>
    <tr>
      <th>2015-07-02</th>
      <td>44.57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="recursive-strategy">
<h4>Recursive strategy<a class="headerlink" href="#recursive-strategy" title="Permalink to this headline">#</a></h4>
<p>This is the strategy used in traditional models such as ARIMA and ETS, it trains a model <span class="math notranslate nohighlight">\(f:\mathbf{y}_{t-1},\mathbf{y}_{t-2},\ldots\mapsto\mathbf{y}_t\)</span>. Denote the last observed value <span class="math notranslate nohighlight">\(y_T\)</span>, the model first predicts <span class="math notranslate nohighlight">\(\hat{y}_{T+1|T}\)</span>, then appends it to the original series to predict <span class="math notranslate nohighlight">\(\hat{y}_{T+2|T+1}\)</span>. This behaviour is repeated until all future time steps have been forecasted. This strategy has a significant weakness, is that it accumulates error each time it makes prediction to a new time step. Hence, requesting forecasts for a large horizon using this strategy is not a good idea, as it can saturate/converge and is no longer accurate.</p>
<a class="reference internal image-reference" href="../_images/forecast_reduction_recursive.png"><img alt="../_images/forecast_reduction_recursive.png" class="align-center" src="../_images/forecast_reduction_recursive.png" style="height: 300px;" /></a>
<br><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nLags</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LGBMRegressor</span><span class="p">()</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">make_reduction</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">nLags</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;recursive&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">NaiveVariance</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfQty</span><span class="p">)</span>
<span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-5 {color: black;background-color: white;}#sk-container-id-5 pre{padding: 0;}#sk-container-id-5 div.sk-toggleable {background-color: white;}#sk-container-id-5 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-5 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-5 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-5 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-5 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-5 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-5 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-5 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-5 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-5 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-5 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-5 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-5 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-5 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-5 div.sk-item {position: relative;z-index: 1;}#sk-container-id-5 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-5 div.sk-item::before, #sk-container-id-5 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-5 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-5 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-5 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-5 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-5 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-5 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-5 div.sk-label-container {text-align: center;}#sk-container-id-5 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-5 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-5" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>NaiveVariance(forecaster=RecursiveTabularRegressionForecaster(estimator=LGBMRegressor(),
                                                              window_length=5))</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox" ><label for="sk-estimator-id-7" class="sk-toggleable__label sk-toggleable__label-arrow">NaiveVariance</label><div class="sk-toggleable__content"><pre>NaiveVariance(forecaster=RecursiveTabularRegressionForecaster(estimator=LGBMRegressor(),
                                                              window_length=5))</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox" ><label for="sk-estimator-id-8" class="sk-toggleable__label sk-toggleable__label-arrow">forecaster: RecursiveTabularRegressionForecaster</label><div class="sk-toggleable__content"><pre>RecursiveTabularRegressionForecaster(estimator=LGBMRegressor(), window_length=5)</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-9" type="checkbox" ><label for="sk-estimator-id-9" class="sk-toggleable__label sk-toggleable__label-arrow">estimator: LGBMRegressor</label><div class="sk-toggleable__content"><pre>LGBMRegressor()</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-10" type="checkbox" ><label for="sk-estimator-id-10" class="sk-toggleable__label sk-toggleable__label-arrow">LGBMRegressor</label><div class="sk-toggleable__content"><pre>LGBMRegressor()</pre></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict_quantiles</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">Quantiles</th>
    </tr>
    <tr>
      <th></th>
      <th>0.1</th>
      <th>0.5</th>
      <th>0.9</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-03</th>
      <td>30.854224</td>
      <td>46.700918</td>
      <td>62.547613</td>
    </tr>
    <tr>
      <th>2015-07-04</th>
      <td>62.759034</td>
      <td>79.105981</td>
      <td>95.452927</td>
    </tr>
    <tr>
      <th>2015-07-05</th>
      <td>56.578788</td>
      <td>73.969520</td>
      <td>91.360253</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">forecaster_</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([83, 82, 48, 70, 73])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nTop</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;lag</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)],</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">forecaster_</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
<span class="p">})</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;importance &gt; 0&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">nTop</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/sktime-forecasting-pipeline_36_0.png"><img alt="../_images/sktime-forecasting-pipeline_36_0.png" class="align-center" src="../_images/sktime-forecasting-pipeline_36_0.png" style="width: 333.0px; height: 126.0px;" /></a>
</div>
</div>
</section>
<section id="direct-strategy">
<h4>Direct strategy<a class="headerlink" href="#direct-strategy" title="Permalink to this headline">#</a></h4>
<p>This strategy, in the other hand, trains a separate model for each time step: <span class="math notranslate nohighlight">\(f_h:\mathbf{y}_{t-h},\mathbf{y}_{t-(h+1)},\ldots\mapsto\mathbf{y}_t\)</span>. As the number of models need to be train equals to the length of the forecasting horizon, this method is more computationally expensive but more accurate than recursive reduction. Keep in mind that making forecast to a far time step prevents using recent lags (<span class="math notranslate nohighlight">\(y_{t-1},\ldots,y_{t-(h-1)}\)</span>). In other the words, if <span class="math notranslate nohighlight">\(h\)</span> is large then <span class="math notranslate nohighlight">\(f_h\)</span> is trained on less features and thus has less prediction power. Also note that because this method is a combination of multiple models, we must specify the forecasting horizon when fitting it to the data.</p>
<a class="reference internal image-reference" href="../_images/forecast_reduction_direct.png"><img alt="../_images/forecast_reduction_direct.png" class="align-center" src="../_images/forecast_reduction_direct.png" style="height: 300px;" /></a>
<br><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nLags</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">make_reduction</span><span class="p">(</span><span class="n">LGBMRegressor</span><span class="p">(),</span> <span class="n">window_length</span><span class="o">=</span><span class="n">nLags</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">scitype</span><span class="o">=</span><span class="s1">&#39;tabular-regressor&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfTemp</span><span class="p">,</span> <span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-11 {color: black;background-color: white;}#sk-container-id-11 pre{padding: 0;}#sk-container-id-11 div.sk-toggleable {background-color: white;}#sk-container-id-11 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-11 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-11 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-11 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-11 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-11 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-11 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-11 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-11 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-11 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-11 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-11 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-11 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-11 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-11 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-11 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-11 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-11 div.sk-item {position: relative;z-index: 1;}#sk-container-id-11 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-11 div.sk-item::before, #sk-container-id-11 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-11 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-11 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-11 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-11 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-11 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-11 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-11 div.sk-label-container {text-align: center;}#sk-container-id-11 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-11 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-11" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DirectTabularRegressionForecaster(estimator=LGBMRegressor())</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-24" type="checkbox" ><label for="sk-estimator-id-24" class="sk-toggleable__label sk-toggleable__label-arrow">DirectTabularRegressionForecaster</label><div class="sk-toggleable__content"><pre>DirectTabularRegressionForecaster(estimator=LGBMRegressor())</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-25" type="checkbox" ><label for="sk-estimator-id-25" class="sk-toggleable__label sk-toggleable__label-arrow">estimator: LGBMRegressor</label><div class="sk-toggleable__content"><pre>LGBMRegressor()</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-26" type="checkbox" ><label for="sk-estimator-id-26" class="sk-toggleable__label sk-toggleable__label-arrow">LGBMRegressor</label><div class="sk-toggleable__content"><pre>LGBMRegressor()</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-04-04 15:00:00</th>
      <td>26.332280</td>
    </tr>
    <tr>
      <th>2005-04-04 16:00:00</th>
      <td>29.458241</td>
    </tr>
    <tr>
      <th>2005-04-04 17:00:00</th>
      <td>25.562921</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([393, 332, 205, 242, 265, 283, 170, 166, 261, 683], dtype=int32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="hybrid-strategy">
<h4>Hybrid strategy<a class="headerlink" href="#hybrid-strategy" title="Permalink to this headline">#</a></h4>
<p>Sktime also develops a hybrid method that combines two above strategies, called <em>dir-rec</em>. It also has a recursive behaviour, but after appending <span class="math notranslate nohighlight">\(\hat{y}_{T+h|T+(h-1)}\)</span>, it trains a new model to predict the next step <span class="math notranslate nohighlight">\(\hat{y}_{T+(h+1)|T+h}\)</span>. However, because both recursion reduction and direct reduction are not good at forecasting far horizons, <em>dir-rec</em> also suffers from this problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nLags</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">make_reduction</span><span class="p">(</span><span class="n">LGBMRegressor</span><span class="p">(),</span> <span class="n">window_length</span><span class="o">=</span><span class="n">nLags</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;dirrec&#39;</span><span class="p">,</span> <span class="n">scitype</span><span class="o">=</span><span class="s1">&#39;tabular-regressor&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfTemp</span><span class="p">,</span> <span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-3 {color: black;background-color: white;}#sk-container-id-3 pre{padding: 0;}#sk-container-id-3 div.sk-toggleable {background-color: white;}#sk-container-id-3 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-3 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-3 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-3 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-3 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-3 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-3 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-3 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-3 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-3 div.sk-item {position: relative;z-index: 1;}#sk-container-id-3 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-3 div.sk-item::before, #sk-container-id-3 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-3 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-3 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-3 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-3 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-3 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-3 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-3 div.sk-label-container {text-align: center;}#sk-container-id-3 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-3 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DirRecTabularRegressionForecaster(estimator=LGBMRegressor())</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox" ><label for="sk-estimator-id-7" class="sk-toggleable__label sk-toggleable__label-arrow">DirRecTabularRegressionForecaster</label><div class="sk-toggleable__content"><pre>DirRecTabularRegressionForecaster(estimator=LGBMRegressor())</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox" ><label for="sk-estimator-id-8" class="sk-toggleable__label sk-toggleable__label-arrow">estimator: LGBMRegressor</label><div class="sk-toggleable__content"><pre>LGBMRegressor()</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-9" type="checkbox" ><label for="sk-estimator-id-9" class="sk-toggleable__label sk-toggleable__label-arrow">LGBMRegressor</label><div class="sk-toggleable__content"><pre>LGBMRegressor()</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
</section>
<section id="multivariate-reducer">
<h4>Multivariate reducer<a class="headerlink" href="#multivariate-reducer" title="Permalink to this headline">#</a></h4>
<p>As Sktime currently does not support forecasting reduction for multivariate time series (where multiple time series grow together), we are going to use Skforecast’s <a class="reference external" href="https://joaquinamatrodrigo.github.io/skforecast/0.5.1/user_guides/multi-time-series-forecasting.html">multivariate forecasting</a> instead. Its class <a class="reference external" href="https://joaquinamatrodrigo.github.io/skforecast/0.5.1/api/ForecasterMultiSeries.html"><code class="docutils literal notranslate"><span class="pre">ForecasterAutoregMultiSeries</span></code></a> assumes multiple time series are independent but follow the same patterns (for example, the sales of different products in the same store).</p>
<p>Another reducer being capable of modeling relationship between different time series are being developed. Its assumption is that, each time series depends not only on its own past values, but also on past values of other time series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfTemp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/air_quality.csv&#39;</span><span class="p">)</span>
<span class="n">dfTemp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">dfTemp</span>
    <span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">select_columns</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_humidity&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_humidity&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">dfTemp</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
      <th>rel_humidity</th>
      <th>abs_humidity</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-04-04 10:00:00</th>
      <td>21.9</td>
      <td>29.3</td>
      <td>0.7568</td>
    </tr>
    <tr>
      <th>2005-04-04 11:00:00</th>
      <td>24.3</td>
      <td>23.7</td>
      <td>0.7119</td>
    </tr>
    <tr>
      <th>2005-04-04 12:00:00</th>
      <td>26.9</td>
      <td>18.3</td>
      <td>0.6406</td>
    </tr>
    <tr>
      <th>2005-04-04 13:00:00</th>
      <td>28.3</td>
      <td>13.5</td>
      <td>0.5139</td>
    </tr>
    <tr>
      <th>2005-04-04 14:00:00</th>
      <td>28.5</td>
      <td>13.1</td>
      <td>0.5028</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ForecasterAutoregMultiSeries</span><span class="p">(</span>
    <span class="n">LGBMRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">lags</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfTemp</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict_interval</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pred</th>
      <th>lower_bound</th>
      <th>upper_bound</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-04-04 15:00:00</th>
      <td>29.337819</td>
      <td>27.115810</td>
      <td>32.904596</td>
    </tr>
    <tr>
      <th>2005-04-04 16:00:00</th>
      <td>29.320193</td>
      <td>21.437085</td>
      <td>35.128758</td>
    </tr>
    <tr>
      <th>2005-04-04 17:00:00</th>
      <td>28.888693</td>
      <td>20.691483</td>
      <td>36.479229</td>
    </tr>
    <tr>
      <th>2005-04-04 18:00:00</th>
      <td>28.581748</td>
      <td>18.914208</td>
      <td>37.279164</td>
    </tr>
    <tr>
      <th>2005-04-04 19:00:00</th>
      <td>28.345217</td>
      <td>16.265546</td>
      <td>38.106760</td>
    </tr>
    <tr>
      <th>2005-04-04 20:00:00</th>
      <td>28.345217</td>
      <td>4.779529</td>
      <td>38.194939</td>
    </tr>
    <tr>
      <th>2005-04-04 21:00:00</th>
      <td>28.581748</td>
      <td>4.449700</td>
      <td>38.651095</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>importance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lag_1</td>
      <td>273</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lag_2</td>
      <td>111</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lag_3</td>
      <td>63</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lag_4</td>
      <td>66</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lag_5</td>
      <td>126</td>
    </tr>
    <tr>
      <th>5</th>
      <td>abs_humidity</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>rel_humidity</td>
      <td>13</td>
    </tr>
    <tr>
      <th>7</th>
      <td>temp</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>
<section id="forecasting-validation">
<h2>2. Forecasting validation<a class="headerlink" href="#forecasting-validation" title="Permalink to this headline">#</a></h2>
<section id="scoring-metrics">
<h3>2.1. Scoring metrics<a class="headerlink" href="#scoring-metrics" title="Permalink to this headline">#</a></h3>
<p>Sktime supports a lot of <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/performance_metrics.html">performance metrics</a> for time series forecasting. To better understand all of them, let’s first break down each metric into three parts: <em>error</em> function, <em>squared</em> flag and <em>aggregation</em> strategy. We illustrate the break down process using a familiar metric, mean squared error.</p>
<ul class="simple">
<li><p>The type of error refers to how error is calculated for each observation. This is the centre of the metric and will be discussed later. In the case of MSE, the error is simply the difference between the true and forecasting values.</p></li>
<li><p>Errors calculated in any way can be positive or negative, so they can eliminate each other. We can either take the <em>absolute</em> value or <em>squared</em> value to make the errors always positive. The choice of square function penalizes large errors.</p></li>
<li><p>Two above functions give us the error for each observation, so we need a function to aggregate the result for the entire target variable. Most popular options are (arithmetic) <em>mean</em> and <em>median</em>, but people also use <em>geometric mean</em>.</p></li>
</ul>
<p>For summary, all types of error present in this section have the term <span class="math notranslate nohighlight">\(y_t-\hat{y}_t\)</span> in their nominator, so that they are all <em>lower-is-better</em>. Their ranges are <span class="math notranslate nohighlight">\((0,\infty)\)</span>, and their best values are <span class="math notranslate nohighlight">\(0\)</span>.</p>
<section id="baseline-forecasters">
<h4>Baseline forecasters<a class="headerlink" href="#baseline-forecasters" title="Permalink to this headline">#</a></h4>
<p>Many evaluation metrics for time series forecasting involve a <a class="reference external" href="https://en.wikipedia.org/wiki/Forecasting#Categories_of_forecasting_methods">baseline model</a> (also known as benchmark model) in its calculation. The reason is very simple: because these baseline forecasters really make sense. Sktime implements all three strategies via the class <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.naive.NaiveForecaster.html"><code class="docutils literal notranslate"><span class="pre">NaiveForecaster</span></code></a>.</p>
<ul class="simple">
<li><p><em>Average model</em>: the forecast for all future values are equal to the average of observed values:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{y}_t=\frac{y_1+y_2+\ldots+y_T}{T}\]</div>
<ul class="simple">
<li><p><em>Drift model</em>: we draw a line from the first to the last observed point, then extrapolate it into the future:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{y}_t=y_1+t\left(\frac{y_T-y_1}{T-1}\right)\]</div>
<ul class="simple">
<li><p><em>Naive model</em>: we take the last observed value of the same season (time step <span class="math notranslate nohighlight">\(t-m\)</span>, with <span class="math notranslate nohighlight">\(m\)</span> the seasonal period) as the forecast at a time step. If data has no seasonality then <span class="math notranslate nohighlight">\(m=1\)</span>. The formulation is:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{y}_t=y_{t-m} \]</div>
</section>
<section id="difference-error">
<h4>Difference error<a class="headerlink" href="#difference-error" title="Permalink to this headline">#</a></h4>
<div class="math notranslate nohighlight">
\[e_t=y_t-\hat{y}_t\]</div>
<p>Two popular metrics of this type are <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_squared_error">MSE</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_absolute_error">MAE</a>, also have been seen in evaluating regression problems. These two metrics are scale-dependent, so that they can express in the same unit as the time series. Scale-dependence is also a disadvantage, as we cannot use these metrics to decide if a model is good enough.</p>
<p>An approach to solve this is to take the ratio between the metric of our Machine Learning model (like <span class="math notranslate nohighlight">\(\text{MSE}\)</span>) and the metric of a naive baseline forecaster (<span class="math notranslate nohighlight">\(\text{MSE}^*\)</span>). This metric is called <em>Relative Loss</em>, computed as:</p>
<div class="math notranslate nohighlight">
\[\text{RelativeMSE}=\frac{\text{MSE}}{\text{MSE}^*} \]</div>
</section>
<section id="percentage-error">
<h4>Percentage error<a class="headerlink" href="#percentage-error" title="Permalink to this headline">#</a></h4>
<div class="math notranslate nohighlight">
\[e_t=\frac{y_t-\hat{y}_t}{y_t}\]</div>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Mean_absolute_percentage_error">MAPE</a> is the most popular metric for this type of error. It is <em>scale-independent</em> and <em>high-interpretable</em>, so it can be considered the standard metric for forecasting tasks. However, percentage error suffers from many known issues:</p>
<ul class="simple">
<li><p>It cannot be used when <span class="math notranslate nohighlight">\(y_t=0\)</span> and tends towards infinity when <span class="math notranslate nohighlight">\(y_t\approx0\)</span>.</p></li>
<li><p>It is meaningless for data in <a class="reference external" href="https://en.wikipedia.org/wiki/Level_of_measurement#Interval_scale">interval scale</a> (for example, temperatures), in which the ratio is not defined.</p></li>
<li><p>An controversial issue that percentage error is said to have, is its asymmetry. The symmetric counterpart is given by:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[e_t=\frac{2(y_t-\hat{y}_t)}{|y_t|+|\hat{y}_t|} \]</div>
<p>In this formula, the nominator is multiplied by <span class="math notranslate nohighlight">\(2\)</span> as a compensation for larger denominator. The symmetric variant of MAPE is called <a class="reference external" href="https://en.wikipedia.org/wiki/Symmetric_mean_absolute_percentage_error">sMAPE</a>. When we switch the position of <span class="math notranslate nohighlight">\(y_t\)</span> and <span class="math notranslate nohighlight">\(\hat{y}_t\)</span>, sMAPE does not change like MAPE. We can see their behaviors in action:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Actual</p></th>
<th class="text-align:center head"><p>Forecast</p></th>
<th class="text-align:center head"><p>Difference</p></th>
<th class="text-align:center head"><p>MAPE</p></th>
<th class="text-align:center head"><p>sMAPE</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>100</p></td>
<td class="text-align:center"><p>80</p></td>
<td class="text-align:center"><p>20</p></td>
<td class="text-align:center"><p>20%</p></td>
<td class="text-align:center"><p>22%</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>80</p></td>
<td class="text-align:center"><p>100</p></td>
<td class="text-align:center"><p>-20</p></td>
<td class="text-align:center"><p>25%</p></td>
<td class="text-align:center"><p>22%</p></td>
</tr>
</tbody>
</table>
<p>However, the above case is not quite a problem of MAPE because we would never compare values that way. In fact, sMAPE symmetrizes one case but makes another case asymmetric:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Actual</p></th>
<th class="text-align:center head"><p>Forecast</p></th>
<th class="text-align:center head"><p>Difference</p></th>
<th class="text-align:center head"><p>MAPE</p></th>
<th class="text-align:center head"><p>sMAPE</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>100</p></td>
<td class="text-align:center"><p>80</p></td>
<td class="text-align:center"><p>20</p></td>
<td class="text-align:center"><p>20%</p></td>
<td class="text-align:center"><p>22%</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>100</p></td>
<td class="text-align:center"><p>120</p></td>
<td class="text-align:center"><p>-20</p></td>
<td class="text-align:center"><p>20%</p></td>
<td class="text-align:center"><p>18%</p></td>
</tr>
</tbody>
</table>
<p>The later case, in the other hand, shows a critical issue of sMAPE: it penalizes forecasts that are lower than ground truth. So that it’s likely to encourages higher forecasts and can lead to biases. Overall, MAPE is still the better metric in my opinion.</p>
</section>
<section id="relative-error">
<h4>Relative error<a class="headerlink" href="#relative-error" title="Permalink to this headline">#</a></h4>
<div class="math notranslate nohighlight">
\[e_t=\frac{y_t-\hat{y}_t}{y_t-\hat{y}_t^*} \]</div>
<p>As the name states, this metric expresses the relative error between our forecaster and a benchmark model. Due to the scale-free property, it is recommended to take the absolute value of relative error rather than squared value. In addition, geometric mean and median is prefered to arithmetic mean, making GMRAE and MdRAE two most popular metrics using this type of error.</p>
</section>
<section id="scaled-error">
<h4>Scaled error<a class="headerlink" href="#scaled-error" title="Permalink to this headline">#</a></h4>
<div class="math notranslate nohighlight">
\[e_t=\frac{y_t-\hat{y}_t}{\text{MAE}^*}\]</div>
<p>This is another error type makes use of a benchmark model. Specifically, it computes <span class="math notranslate nohighlight">\(\text{MAE}^*\)</span> of the in-sample one-step naive forecast (forecast using last observed value, or using value of the same season in the last period). The typical metric of this type is <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_absolute_scaled_error">MASE</a>, it tells us how many times our model performs worse than the naive forecast, with a <span class="math notranslate nohighlight">\(&lt;1\)</span> value indicates excellent performance. This metric, along with MAPE are considered the best metrics for forecasting problems. MASE has the following desired properties:</p>
<ul class="simple">
<li><p>It is scale-free, so can be used for different data with different scales</p></li>
<li><p>It is symmetric, covers both cases that either MAPE or sMAPE suffers from</p></li>
<li><p>It is stable when <span class="math notranslate nohighlight">\(y_t\approx0\)</span></p></li>
<li><p>It is easy to interpret</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>MASE is not a fair metric at all, as our model is usually assessed for a longer horizon than the naive method. Imagine we request forecast for the next two years (<span class="math notranslate nohighlight">\(H=8\)</span> steps ahead) of a quarterly time series (<span class="math notranslate nohighlight">\(m=4\)</span>), this means our model has stacked up errors for <span class="math notranslate nohighlight">\(H/m=2\)</span> times compared to the naive forecast. So in my opinion, the correct way to read MASE is:</p>
<ul class="simple">
<li><p>For seasonal time series, evaluate MASE only on forecasts of the next season.</p></li>
<li><p>For non-seasonal time series (where <span class="math notranslate nohighlight">\(m=1\)</span>), MASE cannot track how errors accumulated, so a <span class="math notranslate nohighlight">\(&gt;1\)</span> score is not that bad.</p></li>
</ul>
</div>
</section>
<section id="implementation">
<h4>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">#</a></h4>
<p>Sktime provides two APIs to compute metrics, function interface and class interface. There are some notes when implementing evaluation metrics in Sktime:</p>
<ul class="simple">
<li><p>For metrics with different variants and settings (such as sMAPE, RMSE and RelMSE), it is recommended to use the class interface. Otherwise, the function interface will be more convenient.</p></li>
<li><p>Metrics using <em>relative error</em> (such as MdRAE and GMRAE) require the forecasted values of the baseline model to be provided via the parameter
<code class="docutils literal notranslate"><span class="pre">y_pred_benchmark</span></code>.
This currently prevents relative error to be used in Sktime’s backtesting.</p></li>
<li><p>Metrics using <em>scaled error</em> (such as MASE) require the training values to be provided via the parameter
<code class="docutils literal notranslate"><span class="pre">y_train</span></code>.
Same as the case of relative error, this behaviour can make the validation phase more complicated.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sktime.performance_metrics.forecasting</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">mean_absolute_error</span> <span class="k">as</span> <span class="n">MAE</span><span class="p">,</span>
    <span class="n">mean_squared_error</span> <span class="k">as</span> <span class="n">MSE</span><span class="p">,</span>
    <span class="n">mean_absolute_percentage_error</span> <span class="k">as</span> <span class="n">MAPE</span><span class="p">,</span>
    <span class="n">median_absolute_percentage_error</span> <span class="k">as</span> <span class="n">MdAPE</span><span class="p">,</span>
    <span class="n">median_relative_absolute_error</span> <span class="k">as</span> <span class="n">MdRAE</span><span class="p">,</span>
    <span class="n">geometric_mean_relative_absolute_error</span> <span class="k">as</span> <span class="n">GMRAE</span><span class="p">,</span>
    <span class="n">mean_absolute_scaled_error</span> <span class="k">as</span> <span class="n">MASE</span><span class="p">,</span>
    
    <span class="n">RelativeLoss</span><span class="p">,</span>
    <span class="n">MeanSquaredError</span><span class="p">,</span>
    <span class="n">MeanAbsolutePercentageError</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">MSE</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">(</span><span class="n">square_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">MAPE</span> <span class="o">=</span> <span class="n">MeanAbsolutePercentageError</span><span class="p">()</span>
<span class="n">sMAPE</span> <span class="o">=</span> <span class="n">MeanAbsolutePercentageError</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">RelMSE</span> <span class="o">=</span> <span class="n">RelativeLoss</span><span class="p">(</span><span class="n">relative_loss_function</span><span class="o">=</span><span class="n">MSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MSE</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;requires-y-train&#39;: False,
 &#39;requires-y-pred-benchmark&#39;: False,
 &#39;univariate-only&#39;: False,
 &#39;lower_is_better&#39;: True,
 &#39;inner_implements_multilevel&#39;: False}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfTemp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/air_quality.csv&#39;</span><span class="p">)</span>
<span class="n">dfTemp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">dfTemp</span>
    <span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">select_columns</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2004-01-15&#39;</span><span class="p">:</span> <span class="s1">&#39;2005-03-15&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">dfTemp</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-03-15 19:00:00</th>
      <td>18.0</td>
    </tr>
    <tr>
      <th>2005-03-15 20:00:00</th>
      <td>16.4</td>
    </tr>
    <tr>
      <th>2005-03-15 21:00:00</th>
      <td>14.9</td>
    </tr>
    <tr>
      <th>2005-03-15 22:00:00</th>
      <td>13.8</td>
    </tr>
    <tr>
      <th>2005-03-15 23:00:00</th>
      <td>13.2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nTest</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">yTrain</span> <span class="o">=</span> <span class="n">dfTemp</span><span class="p">[:</span><span class="o">-</span><span class="n">nTest</span><span class="p">]</span>
<span class="n">yTest</span> <span class="o">=</span> <span class="n">dfTemp</span><span class="p">[</span><span class="o">-</span><span class="n">nTest</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoARIMA</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">yTrain</span><span class="p">)</span>
<span class="n">fh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nTest</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">yTestPred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelBase</span> <span class="o">=</span> <span class="n">NaiveForecaster</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">modelBase</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">yTrain</span><span class="p">)</span>
<span class="n">yTestBase</span> <span class="o">=</span> <span class="n">modelBase</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAPE</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">yTestPred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2613456329434634
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MdRAE</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">yTestPred</span><span class="p">,</span> <span class="n">y_pred_benchmark</span><span class="o">=</span><span class="n">yTestBase</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.347392172326816
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MASE</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">yTestPred</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">yTrain</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.3138984386307935
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="backtesting">
<h3>2.2. Backtesting<a class="headerlink" href="#backtesting" title="Permalink to this headline">#</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Backtesting">Backtesting</a> is the validation strategy dedicated for time series forecasting. The idea is to go back to the past, try different forecasters to decide which one best fits to our data. Backtesting can be either holdout validation or cross validation, but holdout validation is significantly biased for time series becasue data changes over time, so we highly recommend using cross validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAPE</span> <span class="o">=</span> <span class="n">MAPE</span><span class="p">()</span>
<span class="n">MASE</span> <span class="o">=</span> <span class="n">MASE</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfQty</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/weekly_quantity.csv&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;date = date.astype(&#39;datetime64&#39;)&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>
    <span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">dfQty</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-06-28</th>
      <td>81.97</td>
    </tr>
    <tr>
      <th>2015-06-29</th>
      <td>59.83</td>
    </tr>
    <tr>
      <th>2015-06-30</th>
      <td>47.84</td>
    </tr>
    <tr>
      <th>2015-07-01</th>
      <td>52.20</td>
    </tr>
    <tr>
      <th>2015-07-02</th>
      <td>44.57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="cross-validation">
<h4>Cross validation<a class="headerlink" href="#cross-validation" title="Permalink to this headline">#</a></h4>
<p>Currently, Sktime supports three splitting strategies for rolling backtesting:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.model_selection.CutoffSplitter.html"><code class="docutils literal notranslate"><span class="pre">CutoffSplitter</span></code></a> splits the time series at provided cutoff points with a fixed training window length.</p></li>
<li><p><a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.model_selection.SlidingWindowSplitter.html"><code class="docutils literal notranslate"><span class="pre">SlidingWindowSplitter</span></code></a> is very much like cutoff splitter, but it uses all possible cutoffs rather than requires users to explicitly specify the locations. Visually, we can think about this strategy as <em>sliding</em> the observed window incrementally. There can be a large number of splits returned by this strategy, we can easily reduce it by setting a high sliding velocity.</p></li>
<li><p><a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.model_selection.ExpandingWindowSplitter.html"><code class="docutils literal notranslate"><span class="pre">ExpandingWindowSplitter</span></code></a> is like sliding window strategy, but the origin of the training window is fixed rather than its length. So, the training window is more likely of <em>expanding</em> rather than <em>sliding</em>, thus the name of the strategy.</p></li>
</ul>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">printSplitIndex</span><span class="p">(</span><span class="n">splitter</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">splitter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">splitter</span><span class="p">)[:</span><span class="n">limit</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splitter</span><span class="p">):</span>
        <span class="n">trainStart</span><span class="p">,</span> <span class="n">trainEnd</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">validStart</span><span class="p">,</span> <span class="n">validEnd</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Split #</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="s1">&#39;: &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;train [</span><span class="si">{</span><span class="n">trainStart</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">trainEnd</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="s1">&#39;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;valid [</span><span class="si">{</span><span class="n">validStart</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">validEnd</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">splitter</span> <span class="o">=</span> <span class="n">CutoffSplitter</span><span class="p">(</span><span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cutoffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">]))</span>
<span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dfQty</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">printSplitIndex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Split #1: train [21, 30], valid [31, 33]
Split #2: train [51, 60], valid [61, 63]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">splitter</span> <span class="o">=</span> <span class="n">SlidingWindowSplitter</span><span class="p">(</span><span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">initial_window</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">step_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dfQty</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">printSplitIndex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Split #1: train [0, 50], valid [51, 53]
Split #2: train [61, 70], valid [71, 73]
Split #3: train [81, 90], valid [91, 93]
Split #4: train [101, 110], valid [111, 113]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">splitter</span> <span class="o">=</span> <span class="n">ExpandingWindowSplitter</span><span class="p">(</span><span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">initial_window</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">step_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dfQty</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">printSplitIndex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Split #1: train [0, 50], valid [51, 53]
Split #2: train [0, 70], valid [71, 73]
Split #3: train [0, 90], valid [91, 93]
Split #4: train [0, 110], valid [111, 113]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluate</span><span class="p">(</span>
    <span class="n">forecaster</span><span class="o">=</span><span class="n">AutoARIMA</span><span class="p">(),</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ExpandingWindowSplitter</span><span class="p">(</span><span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">initial_window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">step_length</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">dfQty</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">MASE</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>test_MeanAbsoluteScaledError</th>
      <th>fit_time</th>
      <th>pred_time</th>
      <th>len_train_window</th>
      <th>cutoff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.029594</td>
      <td>1.154232</td>
      <td>0.007957</td>
      <td>50</td>
      <td>2015-04-20</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.618624</td>
      <td>0.931813</td>
      <td>0.006687</td>
      <td>65</td>
      <td>2015-05-05</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.805709</td>
      <td>0.968418</td>
      <td>0.005533</td>
      <td>80</td>
      <td>2015-05-20</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.026234</td>
      <td>0.873023</td>
      <td>0.004768</td>
      <td>95</td>
      <td>2015-06-04</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.768729</td>
      <td>0.981726</td>
      <td>0.005897</td>
      <td>110</td>
      <td>2015-06-19</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="pipeline">
<h4>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this headline">#</a></h4>
<p>Backtesting is not only for finding best set of hyperparameters of the algorithm, but also for finding the best configuration for the preprocessors (transformers, imputers,…). Like Scikit-learn, we are going to gather all necessary preprocessors and forecaster to a single object, called a pipeline. In Sktime, the simplest way is using the function <code class="docutils literal notranslate"><span class="pre">make_pipeline()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecaster</span> <span class="o">=</span> <span class="n">LGBMRegressor</span><span class="p">()</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">make_reduction</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;recursive&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">NaiveVariance</span><span class="p">)</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">Deseasonalizer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;multiplicative&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">Detrender</span><span class="p">(</span><span class="n">PolynomialTrendForecaster</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">Differencer</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">forecaster</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfQty</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-07-03</th>
      <td>34.664694</td>
    </tr>
    <tr>
      <th>2015-07-04</th>
      <td>56.859565</td>
    </tr>
    <tr>
      <th>2015-07-05</th>
      <td>60.504088</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="hyperparameter-tuning">
<h4>Hyperparameter tuning<a class="headerlink" href="#hyperparameter-tuning" title="Permalink to this headline">#</a></h4>
<p>Like in Scikit-learn, Sktime provides two convinient classes that combine hyperparameter tuning with cross validation, <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.model_selection.ForecastingRandomizedSearchCV.html"><code class="docutils literal notranslate"><span class="pre">ForecastingRandomizedSearchCV</span></code></a> and <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.model_selection.ForecastingGridSearchCV.html"><code class="docutils literal notranslate"><span class="pre">ForecastingGridSearchCV</span></code></a>. When implementing, there are some points to notice:</p>
<ul class="simple">
<li><p>Before performing validation splitting, we need to define a test set first. This is supported in Sktime using <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/auto_generated/sktime.forecasting.model_selection.temporal_train_test_split.html"><code class="docutils literal notranslate"><span class="pre">temporal_train_test_split()</span></code></a>, a wrapper function of Sklearn’s counterpart without shuffling.</p></li>
<li><p>As time series data will be quickly outdated, it is necessary to perform either refitting (more accurate) or updating (faster) after each time moving to a new training window. Implemented in both validators via the paramter <code class="docutils literal notranslate"><span class="pre">strategy</span></code>.</p></li>
<li><p>The way we provide scoring strategy to the validators is a bit different from Scikit-learn’s counterparts. While Scikit-learn validators accept a scoring function which is always higher-is-better, Sktime’s validators use its own scoring classes with lower-is-better tag.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fhRel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">FH</span><span class="p">)</span>
<span class="n">yTrain</span><span class="p">,</span> <span class="n">yTest</span> <span class="o">=</span> <span class="n">temporal_train_test_split</span><span class="p">(</span><span class="n">dfQty</span><span class="p">,</span> <span class="n">fh</span><span class="o">=</span><span class="n">fhRel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAPE</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;requires-y-train&#39;: False,
 &#39;requires-y-pred-benchmark&#39;: False,
 &#39;univariate-only&#39;: False,
 &#39;lower_is_better&#39;: True,
 &#39;inner_implements_multilevel&#39;: False}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">Deseasonalizer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;multiplicative&#39;</span><span class="p">),</span>
    <span class="n">Detrender</span><span class="p">(</span><span class="n">PolynomialTrendForecaster</span><span class="p">()),</span>
    <span class="n">Differencer</span><span class="p">(),</span>
    <span class="n">LGBMRegressor</span><span class="p">()</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">make_reduction</span><span class="p">,</span> <span class="n">estimator</span><span class="o">=</span><span class="n">px</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;recursive&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">(</span><span class="n">NaiveVariance</span><span class="p">,</span> <span class="n">forecaster</span><span class="o">=</span><span class="n">px</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">paramsDist</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Deseasonalizer__sp&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="s1">&#39;Detrender__forecaster__degree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;Differencer__lags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;NaiveVariance__forecaster__window_length&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="s1">&#39;NaiveVariance__forecaster__estimator__n_estimators&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;NaiveVariance__forecaster__estimator__learning_rate&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="s1">&#39;NaiveVariance__forecaster__estimator__reg_alpha&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">validator</span> <span class="o">=</span> <span class="n">ForecastingRandomizedSearchCV</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;refit&#39;</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ExpandingWindowSplitter</span><span class="p">(</span><span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">initial_window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">step_length</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
    <span class="n">param_distributions</span><span class="o">=</span><span class="n">paramsDist</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">MAPE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">validator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">yTrain</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0:05:30.278628
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validator</span><span class="o">.</span><span class="n">cv_results_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank_test_MeanAbsolutePercentageError&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_test_MeanAbsolutePercentageError</th>
      <th>mean_fit_time</th>
      <th>mean_pred_time</th>
      <th>params</th>
      <th>rank_test_MeanAbsolutePercentageError</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12</th>
      <td>0.171803</td>
      <td>5.013909</td>
      <td>0.030075</td>
      <td>{'Deseasonalizer__sp': 7, 'Detrender__forecast...</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.178518</td>
      <td>3.502678</td>
      <td>0.026957</td>
      <td>{'Deseasonalizer__sp': 7, 'Detrender__forecast...</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.201939</td>
      <td>2.974035</td>
      <td>0.028860</td>
      <td>{'Deseasonalizer__sp': 4, 'Detrender__forecast...</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yTestPred</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fhRel</span><span class="p">)</span>
<span class="n">MASE</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">yTestPred</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">yTrain</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7581567925016461
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validator</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;Deseasonalizer__sp&#39;: 7,
 &#39;Detrender__forecaster__degree&#39;: 1,
 &#39;Differencer__lags&#39;: 1,
 &#39;NaiveVariance__forecaster__estimator__learning_rate&#39;: 0.30785428479140053,
 &#39;NaiveVariance__forecaster__estimator__n_estimators&#39;: 48,
 &#39;NaiveVariance__forecaster__estimator__reg_alpha&#39;: 16.646455352411678,
 &#39;NaiveVariance__forecaster__window_length&#39;: 5}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mapeValid</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">best_score_</span>
<span class="n">mapeTest</span> <span class="o">=</span> <span class="n">MAPE</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">yTestPred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MAPEValid=</span><span class="si">{</span><span class="n">mapeValid</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, MAPETest=</span><span class="si">{</span><span class="n">mapeTest</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MAPEValid=0.1718, MAPETest=0.1710
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plot_series</span><span class="p">(</span><span class="n">dfQty</span><span class="p">[</span><span class="o">-</span><span class="mi">40</span><span class="p">:],</span> <span class="n">yTestPred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/sktime-forecasting-pipeline_89_0.png"><img alt="../_images/sktime-forecasting-pipeline_89_0.png" class="align-center" src="../_images/sktime-forecasting-pipeline_89_0.png" style="width: 740.0px; height: 198.4px;" /></a>
</div>
</div>
</section>
</section>
</section>
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><em>sktime - <a class="reference external" href="https://nbviewer.org/github/sktime/sktime/blob/4194aacaa105ef59807ea56c1bb3497b37eb1613/examples/01_forecasting.ipynb">Forecasting with Sktime</a></em></p></li>
<li><p><em>typethepipe - <a class="reference external" href="https://typethepipe.com/post/symmetric-mape-is-not-symmetric/">Symmetric MAPE is not symmetric</a></em></p></li>
<li><p><em>medium - <a class="reference external" href="https://towardsdatascience.com/time-series-forecast-error-metrics-you-should-know-cc88b8c67f27">Time series forecast error metrics you should know</a></em></p></li>
<li><p><em>relexsolutions - <a class="reference external" href="https://www.relexsolutions.com/resources/measuring-forecast-accuracy/">Measuring forecast accuracy: The complete guide</a></em></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "hungpq7/tabular-book",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./08-time-series"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="prophet-forecasting-algorithms.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Prophet: Forecasting Algorithms</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="darts-deep-forecasting.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Darts: Deep Forecasting</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Quang Hung &#9829; Thuy Linh<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
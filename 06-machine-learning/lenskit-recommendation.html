
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Lenskit: Recommendation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PySpark: Machine Learning" href="pyspark-machine-learning.html" />
    <link rel="prev" title="Sklearn: Feature Engineering" href="sklearn-feature-engineering.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.svg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../util/intro.html">
                    Data Science
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01-python-programing/_intro.html">
   <b>
    1. Python Programing
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-basic-concepts.html">
     Python: Basic Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-data-types.html">
     Python: Data Types
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-data-containers.html">
     Python: Data Containers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-functions-objects.html">
     Python: Functions and Objects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-algorithms.html">
     (w) Python: Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/python-external-sources.html">
     Python: External Sources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01-python-programing/selenium-web-scraping.html">
     Selenium: Web Scraping
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02-mathematics/_intro.html">
   <b>
    2. Mathematics
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-linear-algebra.html">
     NumPy: Linear Algebra
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/sympy-calculus.html">
     SymPy: Calculus
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-probability.html">
     NumPy: Probability
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-statistics.html">
     NumPy: Statistics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/scipy-hypothesis-testing.html">
     SciPy: Hypothesis Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/numpy-applied-mathematics.html">
     NumPy: Applied Mathematics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02-mathematics/networkx-network-analysis.html">
     (w) NetworkX: Network Analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../03-data-manipulation/_intro.html">
   <b>
    3. Data Manipulation
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/numpy-arrays.html">
     NumPy: Arrays
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/pandas-data-exploratory.html">
     Pandas: Data Exploratory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/pandas-data-cleaning.html">
     Pandas: Data Cleaning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/pandas-data-transformation.html">
     Pandas: Data Transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03-data-manipulation/janitor-pandas-extensions.html">
     Janitor: Pandas Extensions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../04-big-data/_intro.html">
   <b>
    4. Big Data
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/hiveql-data-manipulation.html">
     HiveQL: Data Manipulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/pyspark-data-exploratory.html">
     PySpark: Data Exploratory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/pyspark-data-cleaning.html">
     PySpark: Data Cleaning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/pyspark-data-transformation.html">
     PySpark: Data Transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04-big-data/dask-parallelized-pandas.html">
     Dask: Parallelized Pandas
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../05-data-visualization/_intro.html">
   <b>
    5. Data Visualization
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../05-data-visualization/matplotlib-graph-construction.html">
     Matplotlib: Graph Construction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05-data-visualization/seaborn-statistical-visualization.html">
     Seaborn: Statistical Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05-data-visualization/plotly-interactive-visualization.html">
     Plotly: Interactive Visualization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="_intro.html">
   <b>
    6. Machine Learning
   </b>
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="sklearn-machine-learning.html">
     Sklearn: Machine Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sklearn-classification.html">
     Sklearn: Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sklearn-regression.html">
     Sklearn: Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sklearn-feature-engineering.html">
     Sklearn: Feature Engineering
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Lenskit: Recommendation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pyspark-machine-learning.html">
     PySpark: Machine Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../07-tabular-learning/_intro.html">
   <b>
    7. Tabular Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/sklearn-ensemble-learning.html">
     Sklearn: Ensemble Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/xgboost-tree-boosting.html">
     XGBoost: Tree Boosting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/ray-hyperparameter-optimization.html">
     Ray: Hyperparam Optimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/shap-model-interpretation.html">
     Shap: Model Interpretation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07-tabular-learning/imblearn-targeted-modeling.html">
     Imblearn: Targeted Modeling
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../08-time-series/_intro.html">
   <b>
    8. Time Series
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../08-time-series/statsmodels-temporal-analysis.html">
     Statsmodels: Temporal Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08-time-series/prophet-forecasting-algorithms.html">
     Prophet: Forecasting Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08-time-series/sktime-forecasting-pipeline.html">
     Sktime: Forecasting Pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08-time-series/darts-deep-forecasting.html">
     Darts: Deep Forecasting
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../09-unsupervised-learning/_intro.html">
   <b>
    9. Unsupervised Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/mlxtend-association-rules.html">
     (w) MLxtend: Association Rules
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/sklearn-clustering.html">
     Sklearn: Clustering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/sklearn-dimensional-reduction.html">
     Sklearn: Dimensional Reduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09-unsupervised-learning/pyod-anomaly-detection.html">
     PyOD: Anomaly Detection
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../10-deep-learning/_intro.html">
   <b>
    10. Deep Learning
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/gensim-text-mining.html">
     Gensim: Text Mining
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/opencv-image-processing.html">
     OpenCV: Image Processing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/numpy-gradient-descent.html">
     Python: Gradient Descent
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/keras-multilayer-perceptron.html">
     Keras: Multilayer Perceptron
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/keras-recurrent-networks.html">
     Keras: Recurrent Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/keras-convolutional-networks.html">
     Keras: Convolutional Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/pytorch-deep-learning.html">
     PyTorch: Deep Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10-deep-learning/transformers-transfer-learning.html">
     Transformers: Transfer Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../11-r-programing/_intro.html">
   <b>
    11. R Programing
   </b>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/r-basic-concepts.html">
     R: Basic Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/r-data-structures.html">
     R: Data Structures
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/tidyverse-data-wrangling.html">
     Tidyverse: Data Wrangling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/dplyr-data-cleaning.html">
     Dplyr: Data Cleaning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/ggplot-data-visualization.html">
     Ggplot: Data Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11-r-programing/r-statistics.html">
     R: Statistics
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/hungpq7/tabular-book/master?urlpath=lab/tree/06-machine-learning/lenskit-recommendation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/hungpq7/tabular-book/blob/master/06-machine-learning/lenskit-recommendation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/hungpq7/tabular-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/06-machine-learning/lenskit-recommendation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recommendation-concepts">
   1. Recommendation concepts
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-statement">
     1.1. Problem statement
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#approaches">
       Approaches
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cold-start-problem">
       Cold start problem
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#utility-matrix">
       Utility matrix
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-dataset">
     1.2. The dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-metrics">
     1.3. Evaluation metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ap-k-and-ar-k">
       AP@K and AR@K
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#map-k-and-mar-k">
       MAP@K and MAR@K
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ndcg">
       nDCG
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utility-metrics">
     1.4. Utility metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#coverage">
       Coverage
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#personalization">
       Personalization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#intra-list-similarity">
       Intra-list Similarity
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collaborative-filtering">
   2. Collaborative Filtering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization">
     2.1. Matrix Factorization
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#algorithm">
       Algorithm
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#implementation-lenskit">
       Implementation: Lenskit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#implementation-surprise">
       Implementation: Surprise
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-nn-method">
     2.2. K-NN method
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Algorithm
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aggregating-formulas">
       Aggregating formulas
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Implementation: Lenskit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Implementation: Surprise
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-methods">
   3. Other methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#content-filtering">
     3.1. Content Filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#demographic-filtering">
     3.2. Demographic Filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#regression-approach">
     3.3. Regression approach
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Lenskit: Recommendation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recommendation-concepts">
   1. Recommendation concepts
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-statement">
     1.1. Problem statement
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#approaches">
       Approaches
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cold-start-problem">
       Cold start problem
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#utility-matrix">
       Utility matrix
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-dataset">
     1.2. The dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-metrics">
     1.3. Evaluation metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ap-k-and-ar-k">
       AP@K and AR@K
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#map-k-and-mar-k">
       MAP@K and MAR@K
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ndcg">
       nDCG
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utility-metrics">
     1.4. Utility metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#coverage">
       Coverage
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#personalization">
       Personalization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#intra-list-similarity">
       Intra-list Similarity
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collaborative-filtering">
   2. Collaborative Filtering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization">
     2.1. Matrix Factorization
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#algorithm">
       Algorithm
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#implementation-lenskit">
       Implementation: Lenskit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#implementation-surprise">
       Implementation: Surprise
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-nn-method">
     2.2. K-NN method
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Algorithm
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aggregating-formulas">
       Aggregating formulas
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Implementation: Lenskit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Implementation: Surprise
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-methods">
   3. Other methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#content-filtering">
     3.1. Content Filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#demographic-filtering">
     3.2. Demographic Filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#regression-approach">
     3.3. Regression approach
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="lenskit-recommendation">
<h1>Lenskit: Recommendation<a class="headerlink" href="#lenskit-recommendation" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">ml_metrics</span> <span class="kn">import</span> <span class="n">mapk</span>
<span class="kn">from</span> <span class="nn">recmetrics</span> <span class="kn">import</span> <span class="n">mark</span><span class="p">,</span> <span class="n">prediction_coverage</span><span class="p">,</span> <span class="n">personalization</span><span class="p">,</span> <span class="n">intra_list_similarity</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ndcg_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span> <span class="k">as</span> <span class="n">R2</span><span class="p">,</span> <span class="n">mean_squared_error</span> <span class="k">as</span> <span class="n">MSE</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span><span class="p">,</span> <span class="n">linear_kernel</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="kn">from</span> <span class="nn">lenskit</span> <span class="kn">import</span> <span class="n">batch</span><span class="p">,</span> <span class="n">Recommender</span>
<span class="kn">from</span> <span class="nn">lenskit.algorithms.als</span> <span class="kn">import</span> <span class="n">BiasedMF</span><span class="p">,</span> <span class="n">ImplicitMF</span>
<span class="kn">from</span> <span class="nn">lenskit.algorithms.funksvd</span> <span class="kn">import</span> <span class="n">FunkSVD</span>
<span class="kn">from</span> <span class="nn">lenskit.algorithms.item_knn</span> <span class="kn">import</span> <span class="n">ItemItem</span>
<span class="kn">from</span> <span class="nn">lenskit.algorithms.user_knn</span> <span class="kn">import</span> <span class="n">UserUser</span>

<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">accuracy</span>
<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">SVD</span><span class="p">,</span> <span class="n">KNNBasic</span><span class="p">,</span> <span class="n">KNNWithMeans</span><span class="p">,</span> <span class="n">KNNWithZScore</span><span class="p">,</span> <span class="n">KNNBaseline</span>
<span class="kn">from</span> <span class="nn">surprise.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="recommendation-concepts">
<h2>1. Recommendation concepts<a class="headerlink" href="#recommendation-concepts" title="Permalink to this headline">#</a></h2>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Recommender_system">recommender system</a> or recommendation engine is a program that aims to suggest the most relevant <em>items</em> to each <em>user</em>. With the rise of digital services, recommender systems have taken more and more places in human’s life. Some successful recommender systems are of large companies such as Netflix, Google and Amazon.</p>
<section id="problem-statement">
<h3>1.1. Problem statement<a class="headerlink" href="#problem-statement" title="Permalink to this headline">#</a></h3>
<section id="approaches">
<h4>Approaches<a class="headerlink" href="#approaches" title="Permalink to this headline">#</a></h4>
<p>As seen in familiar services, there are a lot of recommendation kinds such as “similar products”, “best seller products”, “most relevant products” and “people view this also buy this”. Basically, every recommendation problem is some sort of a ranking system, with or without scores; and some ranking problems can be done only by calculating items’ statistics. This section focuses on the most challenging problem, recommendation of most relevant products to a user. Typically, there are two most noticeable recommendation methods:</p>
<ul class="simple">
<li><p><em>Collaborative Filtering</em>. This technique tries to discover people that have the same taste as an user <span class="math notranslate nohighlight">\(u\)</span>, then recommends to <span class="math notranslate nohighlight">\(u\)</span> items have been highly rated by these people. Imagine there are a lot of people who have watched both “Iron Man” and “Captain America”, then if <span class="math notranslate nohighlight">\(u\)</span> watches one of two movies, the other will be recommended.</p></li>
<li><p><em>Content-based Filtering</em>. This technique draws a picture of the user <span class="math notranslate nohighlight">\(u\)</span>’s behaviours, it suggests items that are similar to what <span class="math notranslate nohighlight">\(u\)</span> has purchased in the past. For example, if <span class="math notranslate nohighlight">\(u\)</span> is a Netflix user and has watched so many fantasy movies, then the engine should recommend to <span class="math notranslate nohighlight">\(u\)</span> a movie also having the fantasy genre.</p></li>
<li><p><em>Demographic Filtering</em>, which identifies people that are demographically similar to a user, then extrapolates from their ratings.</p></li>
</ul>
<p>Among the three, Collaborative Filtering is considered the most effective; however, the other approaches still have their own advantages. Therefore, many modern recommender systems use hybridization, which combines two or more methods to gain better performance than individual implementation.</p>
</section>
<section id="cold-start-problem">
<h4>Cold start problem<a class="headerlink" href="#cold-start-problem" title="Permalink to this headline">#</a></h4>
<p>This problem refers to the situation where a recommendation system (especially Collaborative Filtering) fails to predict the ratings for new users and new items, as there are insufficient data for the system to work accurately. Fortunately, Content-based Filtering and Demographic Filtering suffer from this problem less than Collaborative Filtering does:</p>
<ul class="simple">
<li><p>For new users, Demographic Filtering will find existing users that are demographically similar to them</p></li>
<li><p>For new items, Content Filtering will find similar items based on item metadata</p></li>
</ul>
<p>This explains why hybrid systems are preferred in business and become very successful. Another implementation that can help solve the cold-start problem is to directly ask new users what they do like.</p>
</section>
<section id="utility-matrix">
<h4>Utility matrix<a class="headerlink" href="#utility-matrix" title="Permalink to this headline">#</a></h4>
<p>In a recommendation system, there are two important entities, being referred to as <em>users</em> and <em>items</em>. Each user has preferences for some of the items, they can be in the form of rating scores (from 1 to 5) or binary status (like/not like). The whole data is represented as a <em>utility matrix</em>, sometimes called <em>user-item matrix</em>, illustrated as below:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p></p></th>
<th class="text-align:center head"><p>item1</p></th>
<th class="text-align:center head"><p>item2</p></th>
<th class="text-align:center head"><p>item3</p></th>
<th class="text-align:center head"><p>item4</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p><strong>user1</strong></p></td>
<td class="text-align:center"><p>5</p></td>
<td class="text-align:center"><p>1</p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p><strong>user2</strong></p></td>
<td class="text-align:center"><p>3</p></td>
<td class="text-align:center"><p>2</p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p><strong>user3</strong></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p>5</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p><strong>user4</strong></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p>4</p></td>
<td class="text-align:center"><p></p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p><strong>user5</strong></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p>4</p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p>4</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p><strong>user6</strong></p></td>
<td class="text-align:center"><p>2</p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p>1</p></td>
<td class="text-align:center"><p>3</p></td>
</tr>
</tbody>
</table>
<p>Since digital products are designed to serve many people at once, the number of users is usually much larger than the number of items. And as each user only gives ratings to a small number of items, the utility matrix is a sparse matrix most of the time, where most of the entries are null. It is almost impossible to build a recommender system without a utility matrix. There are two ways of collecting data in order to make a utility matrix.</p>
<ul class="simple">
<li><p><em>Explicit ratings</em>, which come directly from asking users to rate items. Easy to collect but usually comes with a lot of missing data, since users are lazy. The rating scores are not trustworthy (depending on personal perspective) and are not updated over time.</p></li>
<li><p><em>Implicit ratings</em>, which are inferences from users’ behavior. This method requires to have some sort of unsupervised formula/rule to map a user’s actions to his ratings. Unlike explicit ratings, implicit ratings are much more trustworthy (behaviors are unconscious) and are up to date.</p></li>
</ul>
</section>
</section>
<section id="the-dataset">
<h3>1.2. The dataset<a class="headerlink" href="#the-dataset" title="Permalink to this headline">#</a></h3>
<p>In this topic, we use the famous <a class="reference external" href="https://grouplens.org/datasets/movielens/100k/">MovieLens 100k dataset</a> containing 100,000 ratings from 943 users on 1682 movies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfUser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/user.csv&#39;</span><span class="p">)</span>
<span class="n">dfUser</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>age</th>
      <th>sex</th>
      <th>occupation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>24</td>
      <td>M</td>
      <td>technician</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>53</td>
      <td>F</td>
      <td>other</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>23</td>
      <td>M</td>
      <td>writer</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>24</td>
      <td>M</td>
      <td>technician</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>33</td>
      <td>F</td>
      <td>other</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfItem</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/item.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;movie_title&#39;</span><span class="p">)</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
<span class="n">dfItem</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movie_id</th>
      <th>release_year</th>
      <th>action</th>
      <th>adventure</th>
      <th>animation</th>
      <th>children</th>
      <th>comedy</th>
      <th>crime</th>
      <th>documentary</th>
      <th>drama</th>
      <th>fantasy</th>
      <th>noir</th>
      <th>horror</th>
      <th>musical</th>
      <th>mystery</th>
      <th>romance</th>
      <th>scifi</th>
      <th>thriller</th>
      <th>war</th>
      <th>western</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1995.000</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1995.000</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1995.000</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1995.000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1995.000</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_test.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingBase</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="evaluation-metrics">
<h3>1.3. Evaluation metrics<a class="headerlink" href="#evaluation-metrics" title="Permalink to this headline">#</a></h3>
<p>Depends on how we build a recommendation system, there are two types of metric can be used to assess its quality. If we have predicted the ratings, then <a class="reference external" href="https://nbviewer.org/github/hungpq7/data-science/blob/main/26.%20%5BScikit-learn%5D%20Machine%20Learning.ipynb#3.3.-Regression-metrics">regression metrics</a>, especially RMSE, are usually chosen. This section mainly focuses on metrics that help us evaluate how well we have sorted the recommended items. For illustration purpose, we assess the performance of a simple baseline model run on the MovieLens dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRating</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>
<span class="n">dfRating</span> <span class="o">=</span> <span class="n">dfRating</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">})</span>

<span class="c1"># fit the Matrix Factorization model</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">BiasedMF</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">Recommender</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfRating</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfPredict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">dfRating</span><span class="p">)</span>
<span class="n">dfPredict</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
<span class="n">dfPredict</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prediction</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">dfPredict</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
<span class="n">dfPredict</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
      <th>prediction</th>
      <th>rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>162</th>
      <td>1</td>
      <td>169</td>
      <td>5</td>
      <td>5.020</td>
      <td>1</td>
    </tr>
    <tr>
      <th>110</th>
      <td>1</td>
      <td>114</td>
      <td>5</td>
      <td>4.951</td>
      <td>2</td>
    </tr>
    <tr>
      <th>114</th>
      <td>1</td>
      <td>119</td>
      <td>5</td>
      <td>4.881</td>
      <td>3</td>
    </tr>
    <tr>
      <th>96</th>
      <td>1</td>
      <td>100</td>
      <td>5</td>
      <td>4.878</td>
      <td>4</td>
    </tr>
    <tr>
      <th>47</th>
      <td>1</td>
      <td>50</td>
      <td>5</td>
      <td>4.857</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="ap-k-and-ar-k">
<h4>AP&#64;K and AR&#64;K<a class="headerlink" href="#ap-k-and-ar-k" title="Permalink to this headline">#</a></h4>
<p>In a recommendation problem:</p>
<ul class="simple">
<li><p>Precision is calculated as the ratio between the number of correct recommendations (<span class="math notranslate nohighlight">\(\text{TP}\)</span>) and the number of recommended items (<span class="math notranslate nohighlight">\(\text{TP}+\text{FP}\)</span>)</p></li>
<li><p>Recall is calculated as the ratio between the number of correct recommendations (<span class="math notranslate nohighlight">\(\text{TP}\)</span>) and the number of actual relevant items (<span class="math notranslate nohighlight">\(\text{TP}+\text{FN}\)</span>)</p></li>
</ul>
<p>Since our system only has a chance to show a few top products to the customers, thus we consider the first <span class="math notranslate nohighlight">\(k\)</span> items to calculate Precision and Recall, resulting in Precision and Recall at cutoff <span class="math notranslate nohighlight">\(K\)</span> (P&#64;K and R&#64;K). However, these two metrics seem to not care about orders, we would want the metrics to reward for front-loading the relevant items. This is where Average Precision and Average Recall up to the <span class="math notranslate nohighlight">\(K^\text{th}\)</span> item (AP&#64;K and AR&#64;K) is used to tackle the problem. Given <span class="math notranslate nohighlight">\(\text{rel}_k\)</span> indicates the relevance status (<span class="math notranslate nohighlight">\(\text{rel}_k=1\)</span> if the <span class="math notranslate nohighlight">\(k^{th}\)</span> item is relevant), here is the formula for AP&#64;K (AR&#64;K can be calculated the same way):</p>
<div class="math notranslate nohighlight">
\[\text{AP&#64;K}=\frac{1}{K}\sum_{k=1}^{K}\text{P&#64;k}\cdot \text{rel}_k\]</div>
<p>In this formula, the higher rank a relevant item has, the more times it will appear in the calculation of P&#64;K, and the more value it contributes to AP&#64;K. The example below computes P&#64;K, R&#64;K, AP&#64;K and AR&#64;K for a recommendation of 8 items to a single user.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">relevant</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;rel&#39;</span><span class="p">:</span> <span class="n">relevant</span><span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP+FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">k</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP+FN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;P@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP+FP&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;AP@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;P@k&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;AP@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AP@k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;R@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TP+FN&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;AR@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;R@k&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;AR@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AR@k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rel</th>
      <th>k</th>
      <th>TP</th>
      <th>TP+FP</th>
      <th>TP+FN</th>
      <th>P@k</th>
      <th>AP@k</th>
      <th>R@k</th>
      <th>AR@k</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.200</td>
      <td>0.200</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>5</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.400</td>
      <td>0.300</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>5</td>
      <td>0.667</td>
      <td>0.667</td>
      <td>0.400</td>
      <td>0.200</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>4</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>0.500</td>
      <td>0.500</td>
      <td>0.400</td>
      <td>0.150</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>5</td>
      <td>0.600</td>
      <td>0.520</td>
      <td>0.600</td>
      <td>0.240</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>6</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>0.500</td>
      <td>0.433</td>
      <td>0.600</td>
      <td>0.200</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>7</td>
      <td>4</td>
      <td>7</td>
      <td>5</td>
      <td>0.571</td>
      <td>0.453</td>
      <td>0.800</td>
      <td>0.286</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>8</td>
      <td>4</td>
      <td>8</td>
      <td>5</td>
      <td>0.500</td>
      <td>0.396</td>
      <td>0.800</td>
      <td>0.250</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="map-k-and-mar-k">
<h4>MAP&#64;K and MAR&#64;K<a class="headerlink" href="#map-k-and-mar-k" title="Permalink to this headline">#</a></h4>
<p>Now we have already known AP&#64;K and AR&#64;K is defined for a single user, there should be an aggregation for all available users. This gives us Mean Average Precision/Recall up to cutoff <span class="math notranslate nohighlight">\(K\)</span> (MAP&#64;K and MAR&#64;K), calculated by taking the mean of all AP&#64;K or AR&#64;K. MAR&#64;K seems not very trustworthy since the number of actual relevant items (<span class="math notranslate nohighlight">\(\text{TP}+\text{FN}\)</span>) fluctuates dramatically from user to user, which makes the vector of AR&#64;K have low values and a high variance.</p>
<p>To calculate MAP&#64;K and MAR&#64;K, it is required to have the binary relevance status. Let’s assume if a user rated an item higher than his average rating, that item is considered relevant.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingMean</span> <span class="o">=</span> <span class="n">dfPredict</span>\
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">})</span>\
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;rating_mean&#39;</span><span class="p">})</span>

<span class="n">dfRelevant</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfRatingMean</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">dfRelevant</span> <span class="o">=</span> <span class="n">dfRelevant</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;rating &gt; rating_mean&#39;</span><span class="p">)</span>
<span class="n">dfRelevant</span> <span class="o">=</span> <span class="n">dfRelevant</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rating_mean&#39;</span><span class="p">])</span>
<span class="n">dfRelevant</span> <span class="o">=</span> <span class="n">dfRelevant</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

<span class="n">listRelevant</span> <span class="o">=</span> <span class="n">dfRelevant</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dfRelevant</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rank</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>...</th>
      <th>596</th>
      <th>604</th>
      <th>605</th>
      <th>618</th>
      <th>619</th>
      <th>632</th>
      <th>636</th>
      <th>642</th>
      <th>657</th>
      <th>662</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>169</td>
      <td>114</td>
      <td>119</td>
      <td>100</td>
      <td>50</td>
      <td>223</td>
      <td>12</td>
      <td>64</td>
      <td>89</td>
      <td>48</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>483</td>
      <td>NaN</td>
      <td>603</td>
      <td>480</td>
      <td>NaN</td>
      <td>12</td>
      <td>185</td>
      <td>50</td>
      <td>357</td>
      <td>479</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>100</th>
      <td>313</td>
      <td>272</td>
      <td>316</td>
      <td>315</td>
      <td>1235</td>
      <td>258</td>
      <td>300</td>
      <td>691</td>
      <td>328</td>
      <td>690</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 546 columns</p>
</div></div></div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

<span class="n">listRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dfRecommend</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rank</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>...</th>
      <th>718</th>
      <th>719</th>
      <th>720</th>
      <th>721</th>
      <th>722</th>
      <th>723</th>
      <th>724</th>
      <th>725</th>
      <th>726</th>
      <th>727</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>169</td>
      <td>114</td>
      <td>119</td>
      <td>100</td>
      <td>50</td>
      <td>223</td>
      <td>12</td>
      <td>64</td>
      <td>89</td>
      <td>48</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>483</td>
      <td>64</td>
      <td>603</td>
      <td>480</td>
      <td>98</td>
      <td>12</td>
      <td>185</td>
      <td>50</td>
      <td>357</td>
      <td>479</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>100</th>
      <td>313</td>
      <td>272</td>
      <td>316</td>
      <td>315</td>
      <td>1235</td>
      <td>258</td>
      <td>300</td>
      <td>691</td>
      <td>328</td>
      <td>690</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 727 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ml_metrics</span> <span class="kn">import</span> <span class="n">mapk</span>
<span class="n">mapk</span><span class="p">(</span><span class="n">listRelevant</span><span class="p">,</span> <span class="n">listRecommend</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9686638388123012
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recmetrics</span> <span class="kn">import</span> <span class="n">mark</span>
<span class="n">mark</span><span class="p">(</span><span class="n">listRelevant</span><span class="p">,</span> <span class="n">listRecommend</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.008870547974471621
</pre></div>
</div>
</div>
</div>
</section>
<section id="ndcg">
<h4>nDCG<a class="headerlink" href="#ndcg" title="Permalink to this headline">#</a></h4>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Discounted_cumulative_gain">Normalized Discounted Cumulative Gain</a> (nDCG) is another popular metric beside MAP&#64;K. Despite having no <em>mean</em> and <em>&#64;K</em> part in the name, NDCG shares the same calculation with MAP&#64;K: computing the metric for a user considering the top <span class="math notranslate nohighlight">\(K\)</span> items, then taking the mean of that metric for all users. The difference is that nDCG defined <span class="math notranslate nohighlight">\(\text{rel}_k\)</span> being the continuous rating score rather than a binary status, hence it contains more information than MAP&#64;K.</p>
<p>The <em>cumulative gain</em> part in nDCG is simply the sum of graded relevance values. We give it <em>ordering information</em> by making each value <em>discounted</em> before summing:</p>
<div class="math notranslate nohighlight">
\[\text{DCG}=\sum_{k=1}^{K}\frac{\text{rel}_k}{\log_2(k+1)}\]</div>
<p>The final step is dividing the metric by the <em>ideal DCG</em>, in order to <em>normalize</em> it ranging from 0 to 1.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRelevant</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>
<span class="n">dfRelevant</span> <span class="o">=</span> <span class="n">dfRelevant</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dfRelevant</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>user</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>101</th>
      <th>102</th>
      <th>103</th>
      <th>104</th>
      <th>105</th>
      <th>106</th>
      <th>107</th>
      <th>...</th>
      <th>94</th>
      <th>940</th>
      <th>941</th>
      <th>942</th>
      <th>943</th>
      <th>95</th>
      <th>96</th>
      <th>97</th>
      <th>98</th>
      <th>99</th>
    </tr>
    <tr>
      <th>rank</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>3.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>...</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5.000</td>
      <td>4.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>4.000</td>
      <td>...</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>4.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>3.000</td>
      <td>...</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>4.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
      <td>5.000</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 943 columns</p>
</div></div></div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
<span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dfRecommend</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>user</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>101</th>
      <th>102</th>
      <th>103</th>
      <th>104</th>
      <th>105</th>
      <th>106</th>
      <th>107</th>
      <th>...</th>
      <th>94</th>
      <th>940</th>
      <th>941</th>
      <th>942</th>
      <th>943</th>
      <th>95</th>
      <th>96</th>
      <th>97</th>
      <th>98</th>
      <th>99</th>
    </tr>
    <tr>
      <th>rank</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>5.020</td>
      <td>4.827</td>
      <td>4.284</td>
      <td>4.118</td>
      <td>3.557</td>
      <td>4.258</td>
      <td>4.173</td>
      <td>4.580</td>
      <td>4.686</td>
      <td>4.491</td>
      <td>...</td>
      <td>4.829</td>
      <td>4.487</td>
      <td>4.900</td>
      <td>5.034</td>
      <td>4.761</td>
      <td>4.617</td>
      <td>5.080</td>
      <td>4.858</td>
      <td>4.600</td>
      <td>4.924</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.951</td>
      <td>4.778</td>
      <td>4.193</td>
      <td>3.920</td>
      <td>3.536</td>
      <td>4.245</td>
      <td>3.978</td>
      <td>4.455</td>
      <td>4.504</td>
      <td>3.359</td>
      <td>...</td>
      <td>4.828</td>
      <td>4.217</td>
      <td>4.510</td>
      <td>4.853</td>
      <td>4.575</td>
      <td>4.567</td>
      <td>4.759</td>
      <td>4.808</td>
      <td>4.438</td>
      <td>4.774</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.881</td>
      <td>4.723</td>
      <td>4.186</td>
      <td>3.883</td>
      <td>3.469</td>
      <td>4.065</td>
      <td>3.916</td>
      <td>4.016</td>
      <td>4.375</td>
      <td>3.037</td>
      <td>...</td>
      <td>4.809</td>
      <td>4.162</td>
      <td>4.459</td>
      <td>4.821</td>
      <td>4.571</td>
      <td>4.540</td>
      <td>4.755</td>
      <td>4.667</td>
      <td>4.400</td>
      <td>4.677</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 943 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ndcg_score</span>
<span class="n">ndcg_score</span><span class="p">(</span><span class="n">dfRelevant</span><span class="p">,</span> <span class="n">dfRecommend</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9413477823778117
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="utility-metrics">
<h3>1.4. Utility metrics<a class="headerlink" href="#utility-metrics" title="Permalink to this headline">#</a></h3>
<p>This section does not focus on the accuracy, but on some special aspects of a recommendation system.</p>
<section id="coverage">
<h4>Coverage<a class="headerlink" href="#coverage" title="Permalink to this headline">#</a></h4>
<p>Simply calculated by the ratio between the number of unique recommended items and the number of items, Coverage measures the percent of items that the recommedation system is able to recommend. Imagine an engine recommends the most popular items to every user, and another engine recommends completely at random. The first engine will have a Coverage very close to 0, while the Coverage of the second one will be very close to 1. Either of these two cases is good.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">listItem</span> <span class="o">=</span> <span class="n">dfRating</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>

<span class="n">listRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dfRecommend</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rank</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>169</td>
      <td>114</td>
      <td>119</td>
      <td>100</td>
      <td>50</td>
    </tr>
    <tr>
      <th>10</th>
      <td>483</td>
      <td>64</td>
      <td>603</td>
      <td>480</td>
      <td>98</td>
    </tr>
    <tr>
      <th>100</th>
      <td>313</td>
      <td>272</td>
      <td>316</td>
      <td>315</td>
      <td>1235</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recmetrics</span> <span class="kn">import</span> <span class="n">prediction_coverage</span>
<span class="n">prediction_coverage</span><span class="p">(</span><span class="n">listRecommend</span><span class="p">,</span> <span class="n">listItem</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.34700000000000003
</pre></div>
</div>
</div>
</div>
</section>
<section id="personalization">
<h4>Personalization<a class="headerlink" href="#personalization" title="Permalink to this headline">#</a></h4>
<p>Personalization is the measure of dissimilarity across users’ recommendation, calculated by subtracting the average cosine similarity of all user’s recommendation pairs from 1. A high value of this metric suggests that recommendations are different, which the recommendation system is highly personalized.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>

<span class="n">listRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dfRecommend</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rank</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>169</td>
      <td>114</td>
      <td>119</td>
      <td>100</td>
      <td>50</td>
    </tr>
    <tr>
      <th>10</th>
      <td>483</td>
      <td>64</td>
      <td>603</td>
      <td>480</td>
      <td>98</td>
    </tr>
    <tr>
      <th>100</th>
      <td>313</td>
      <td>272</td>
      <td>316</td>
      <td>315</td>
      <td>1235</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recmetrics</span> <span class="kn">import</span> <span class="n">personalization</span>
<span class="n">personalization</span><span class="p">(</span><span class="n">listRecommend</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9366335474487395
</pre></div>
</div>
</div>
</div>
</section>
<section id="intra-list-similarity">
<h4>Intra-list Similarity<a class="headerlink" href="#intra-list-similarity" title="Permalink to this headline">#</a></h4>
<p>Intra-list Similarity measures how similar the items are in a recommendation list of a user by taking the average cosine similarity. This metric requires item features to calculate the cosine similarity between each item pair.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>

<span class="n">listRecommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dfRecommend</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rank</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>169</td>
      <td>114</td>
      <td>119</td>
      <td>100</td>
      <td>50</td>
    </tr>
    <tr>
      <th>10</th>
      <td>483</td>
      <td>64</td>
      <td>603</td>
      <td>480</td>
      <td>98</td>
    </tr>
    <tr>
      <th>100</th>
      <td>313</td>
      <td>272</td>
      <td>316</td>
      <td>315</td>
      <td>1235</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recmetrics</span> <span class="kn">import</span> <span class="n">intra_list_similarity</span>
<span class="n">intra_list_similarity</span><span class="p">(</span><span class="n">listRecommend</span><span class="p">,</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;movie_id&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9999996064377343
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="collaborative-filtering">
<h2>2. Collaborative Filtering<a class="headerlink" href="#collaborative-filtering" title="Permalink to this headline">#</a></h2>
<section id="matrix-factorization">
<h3>2.1. Matrix Factorization<a class="headerlink" href="#matrix-factorization" title="Permalink to this headline">#</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Matrix_factorization_(recommender_systems)">Matrix Factorization</a> is a famous collaborative filtering technique, as popularized by Simon Funk during the <a class="reference external" href="https://en.wikipedia.org/wiki/Netflix_Prize">Netflix Prize</a>. Note that this algorithm has nothing to do with <a class="reference external" href="https://en.wikipedia.org/wiki/Singular_value_decomposition">Singular Value Decomposition</a> (SVD); it is more likely of an SVD-like algorithm. However, the name SVD is still used for this family of methods. Besides, some documents refer to this algorithm as Alternating Least Squares (ALS); this name comes from an iterating method for minimizing the loss function.</p>
<section id="algorithm">
<h4>Algorithm<a class="headerlink" href="#algorithm" title="Permalink to this headline">#</a></h4>
<p>The ultimate goal of the algorithm is to factorize the utility matrix <span class="math notranslate nohighlight">\(\mathbf{R}\in\mathbb{R}^{U\times I}\)</span> (there are total of <span class="math notranslate nohighlight">\(U\)</span> users and <span class="math notranslate nohighlight">\(I\)</span> items) as the product of two low-dimensional matrices: <span class="math notranslate nohighlight">\(\hat{\mathbf{R}}=\mathbf{P}\mathbf{Q}^{\text{T}}\)</span>, where <span class="math notranslate nohighlight">\(\mathbf{P}_{U\times K}\)</span> is the user embedding matrix and <span class="math notranslate nohighlight">\(\mathbf{Q}_{I\times K}\)</span> is the item embedding matrix. The idea behind matrix factorization comes from an assumption that there are some kind of <em>latent features</em> (their number gives us the <em>rank</em> <span class="math notranslate nohighlight">\(K\)</span> that satisfies <span class="math notranslate nohighlight">\(K\ll U,I\)</span>) describing the relationship between users and items. Latent features can be thought as usual item features, but they are discovered by the model instead of being labeled manually.</p>
<p>One major problem is that there are biases that appear in real-world applications, which have not been handled yet in the above embedding matrices. For example, a film critic tends to give lower ratings and some items always get higher ratings than average. To capture this, bias terms are introduced, organized in the bias matrix <span class="math notranslate nohighlight">\(\mathbf{B}\)</span> and is added to the product <span class="math notranslate nohighlight">\(\mathbf{P}\mathbf{Q}^{\text{T}}\)</span>. Specifically, the rating user <span class="math notranslate nohighlight">\(u\)</span> (<span class="math notranslate nohighlight">\(u=1,2,\dots,U\)</span>) gives to item <span class="math notranslate nohighlight">\(i\)</span> (<span class="math notranslate nohighlight">\(i=1,2,\dots,I\)</span>) is predicted as:</p>
<div class="math notranslate nohighlight">
\[\hat{r}_{ui}=\mathbf{p}_u\mathbf{q}_i+(b_u+b_i)+\mu\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathbf{p}_u\)</span> is the <span class="math notranslate nohighlight">\(u^{\text{th}}\)</span> row-vector of <span class="math notranslate nohighlight">\(\mathbf{P}\)</span>, indicating the ratings user <span class="math notranslate nohighlight">\(u\)</span> gives to latent features</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{q}_i\)</span> is the <span class="math notranslate nohighlight">\(i^{\text{th}}\)</span> row-vector of <span class="math notranslate nohighlight">\(\mathbf{Q}\)</span>, representing the value of latent features for item <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(b_u\)</span> and <span class="math notranslate nohighlight">\(b_i\)</span> are the biases of user <span class="math notranslate nohighlight">\(u\)</span> and item <span class="math notranslate nohighlight">\(i\)</span>; <span class="math notranslate nohighlight">\(b_u+b_i=\mathbf{B}_{ui}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\mu\)</span> is the average of all ratings</p></li>
</ul>
<p>Note that <span class="math notranslate nohighlight">\(\mathbf{p}_u\)</span>, <span class="math notranslate nohighlight">\(\mathbf{q}_i\)</span>, <span class="math notranslate nohighlight">\(b_u\)</span> and <span class="math notranslate nohighlight">\(b_i\)</span> are only defined when the corresponding user or item is known. To estimate all unknown, we minimize the following loss function:</p>
<div class="math notranslate nohighlight">
\[L(\mathbf{p}_u,\mathbf{q}_i,b_u,b_i)
=\sum_{u=1,i=1}^{U,I}(r_{ui}-\hat{r}_{ui})^2
+\lambda\,(\|\mathbf{p}_u\|^2+\|\mathbf{q}_i\|^2+b_i^2+b_u^2)\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is the regularization coefficient and <span class="math notranslate nohighlight">\(\|\bullet\|_{\text{F}}\)</span> denotes the <a class="reference external" href="https://en.wikipedia.org/wiki/Matrix_norm#Frobenius_norm">Frobenius norm</a> of a matrix. An intuitive illustration of the factorization process is shown below:</p>
<a class="reference internal image-reference" href="../_images/matrix_factorization.png"><img alt="../_images/matrix_factorization.png" class="align-center" src="../_images/matrix_factorization.png" style="height: 250px;" /></a>
</section>
<section id="implementation-lenskit">
<h4>Implementation: Lenskit<a class="headerlink" href="#implementation-lenskit" title="Permalink to this headline">#</a></h4>
<p>This section implements <a class="reference external" href="https://lkpy.readthedocs.io/en/stable/mf.html">Lenskit’s Matrix Factorization</a>. The hyperparameters are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">features</span></code>: the number of latent features (<span class="math notranslate nohighlight">\(k\)</span>), defaults to <em>30</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg</span></code>: the regularization coefficient (<span class="math notranslate nohighlight">\(\lambda\)</span>), defaults to <em>0.1</em>. Can be a tuple with the size of 2 to specify user and item regularization terms separately.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">dfRatingBase</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">})</span>
<span class="n">dfRatingBase</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span> <span class="o">=</span> <span class="n">BiasedMF</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">Recommender</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="c1"># ensure the object to be a Recommender</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfRatingBase</span><span class="p">)</span> <span class="c1"># input columns specified by name: &quot;user&quot;, &quot;item&quot; and &quot;rating&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_test.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">dfRatingTest</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">})</span>

<span class="n">dfPredict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">dfRatingTest</span><span class="p">)</span>
<span class="n">dfPredict</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">prediction</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">dfPredict</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>20</td>
      <td>4</td>
      <td>3.947714</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>33</td>
      <td>4</td>
      <td>3.756196</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>61</td>
      <td>4</td>
      <td>4.045644</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>117</td>
      <td>3</td>
      <td>3.705049</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>155</td>
      <td>2</td>
      <td>2.404567</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">user_features_</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(943, 30)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">item_features_</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1680, 30)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">rating</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">prediction</span>

<span class="n">r2_test</span> <span class="o">=</span> <span class="n">R2</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R2 = </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RMSE = </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 = 29.02%
RMSE = 0.9438
</pre></div>
</div>
</div>
</div>
</section>
<section id="implementation-surprise">
<h4>Implementation: Surprise<a class="headerlink" href="#implementation-surprise" title="Permalink to this headline">#</a></h4>
<p>This section implements <a class="reference external" href="https://surprise.readthedocs.io/en/stable/matrix_factorization.html">Surprise’s Matrix Factorization</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_test.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingBase</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the train set into Surprise&#39;s object</span>
<span class="n">dataTrain</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_from_df</span><span class="p">(</span><span class="n">dfRatingBase</span><span class="p">,</span> <span class="n">Reader</span><span class="p">())</span>
<span class="n">dataTrain</span> <span class="o">=</span> <span class="n">dataTrain</span><span class="o">.</span><span class="n">build_full_trainset</span><span class="p">()</span>

<span class="n">mf</span> <span class="o">=</span> <span class="n">SVD</span><span class="p">()</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataTrain</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After the model has been trained, we can call four attributes <code class="docutils literal notranslate"><span class="pre">pu</span></code>, <code class="docutils literal notranslate"><span class="pre">qi</span></code>, <code class="docutils literal notranslate"><span class="pre">bu</span></code> and <code class="docutils literal notranslate"><span class="pre">bi</span></code> to get the value of <span class="math notranslate nohighlight">\(\mathbf{P}\)</span>, <span class="math notranslate nohighlight">\(\mathbf{Q}\)</span>, user bias and item bias.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">pu</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(943, 100)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">qi</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1680, 100)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">bu</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(943,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">bi</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1680,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iid</span><span class="o">=</span><span class="mi">100001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Prediction(uid=1, iid=100001, r_ui=None, est=3.4044350878268252, details={&#39;was_impossible&#39;: False})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_prediction</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">dfRatingTest</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">user_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">uid</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>
<span class="n">item_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">iid</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>
<span class="n">rating</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">r_ui</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">est</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>

<span class="n">dfPredict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
    <span class="s1">&#39;item_id&#39;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">,</span>
    <span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span>
<span class="p">})</span>
<span class="n">dfPredict</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>rating</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>20</td>
      <td>4</td>
      <td>3.66</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>33</td>
      <td>4</td>
      <td>3.91</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>61</td>
      <td>4</td>
      <td>3.84</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>117</td>
      <td>3</td>
      <td>3.64</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>155</td>
      <td>2</td>
      <td>2.57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">rating</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">prediction</span>

<span class="n">r2_test</span> <span class="o">=</span> <span class="n">R2</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R2 = </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RMSE = </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 = 27.94%
RMSE = 0.9509
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="k-nn-method">
<h3>2.2. K-NN method<a class="headerlink" href="#k-nn-method" title="Permalink to this headline">#</a></h3>
<section id="id1">
<h4>Algorithm<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h4>
<p>This method is quite straightforward, it involves in these steps:</p>
<ul class="simple">
<li><p>Represent each user/item as a vector extracted from the utility matrix. Normalize each vector by subtracting to it the average ratings of that user/item.</p></li>
<li><p>Calculate the similarity matrix for all pairs; the cosine distance is used most of the time.</p></li>
<li><p>Consider <span class="math notranslate nohighlight">\(K\)</span> nearest neighbors, aggregate their ratings as prediction for the item <span class="math notranslate nohighlight">\(i\)</span> that a user <span class="math notranslate nohighlight">\(u\)</span> has not rated yet.</p></li>
</ul>
<p>There are two strategies can be used in the K-NN method: user-based and item-based (some documents refer to them as user-user and item-item). In user-based approach, we try to figure out a maximum of <span class="math notranslate nohighlight">\(K\)</span> users that are most similar to <span class="math notranslate nohighlight">\(u\)</span>, and investigate how they have rated <span class="math notranslate nohighlight">\(i\)</span>. In contrast, the item-based approach finds <span class="math notranslate nohighlight">\(K\)</span> most similar items to <span class="math notranslate nohighlight">\(i\)</span> that have been rated by <span class="math notranslate nohighlight">\(u\)</span>, and investigates how other people think about them. Note that only neighbors with positive similarity are aggregated, since it makes no sense to take into consideration unrelated users/items.</p>
<p>Let’s say <span class="math notranslate nohighlight">\(v\)</span> is one of <span class="math notranslate nohighlight">\(K\)</span> nearest users of <span class="math notranslate nohighlight">\(u\)</span> that have rated <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(v\)</span> is positive similar to <span class="math notranslate nohighlight">\(u\)</span> (<span class="math notranslate nohighlight">\(s_{uv}&gt;0\)</span>); <span class="math notranslate nohighlight">\(j\)</span> is one of <span class="math notranslate nohighlight">\(K\)</span> nearest items of <span class="math notranslate nohighlight">\(i\)</span> that have been rated by <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(j\)</span> is positive similar to <span class="math notranslate nohighlight">\(i\)</span> (<span class="math notranslate nohighlight">\(s_{ij}&gt;0\)</span>). The prediction formulas are:</p>
<ul class="simple">
<li><p>User-based:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{r}_{ui}=\frac{\sum s_{uv}r_{vi}}{\sum s_{uv}}\]</div>
<ul class="simple">
<li><p>Item-based:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{r}_{ui}=\frac{\sum s_{ij}r_{uj}}{\sum s_{ij}}\]</div>
<p>In practice, the item-based approach is more popular as it computes a much smaller similarity matrix than the user-based approach does. Besides, the item-mean vector used in item-based is more <em>stable</em> than user-mean vector. It does not change too frequently when there are new ratings, because each item is rated by many users.</p>
<p>K-NN is a computational expensive method when there are millions of users and items in real-world problems. A clustering algorithm can be paired with this method, now we calculate the similarity matrix on clusters of users/items instead of individual users/items. This technique can reduce a lot of computations, but you must trade-off some quality for scalability since the input data is now less detailed. There is also another improvement is calculating only the similarity between related users/items, since there are so many pairs having no common items/users.</p>
</section>
<section id="aggregating-formulas">
<h4>Aggregating formulas<a class="headerlink" href="#aggregating-formulas" title="Permalink to this headline">#</a></h4>
<p>There are a couple of methods to estimate <span class="math notranslate nohighlight">\(\hat{r}_{ui}\)</span> from <span class="math notranslate nohighlight">\(K\)</span> neighbors; the formula used in the previous section is the simplest one. Since both user-based and item-based methods share the same idea and behavior, we are going to demonstrate some variants of aggregating formulas for user-based method.</p>
<ul class="simple">
<li><p>K-NN with means (<span class="math notranslate nohighlight">\(\mu_u\)</span> and <span class="math notranslate nohighlight">\(\mu_v\)</span> denote the rating mean of user <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>):</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{r}_{ui}=\mu_u+\frac{\sum s_{uv}(r_{vi}-\mu_v)}{\sum s_{uv}}\]</div>
<ul class="simple">
<li><p>K-NN with standardization (<span class="math notranslate nohighlight">\(\sigma_u\)</span> and <span class="math notranslate nohighlight">\(\sigma_v\)</span> denote the standard deviation of user <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>):</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{r}_{ui}=\mu_u+\sigma_u\,\frac{\sum s_{uv}(r_{vi}-\mu_v)/\sigma_v}{\sum s_{uv}}\]</div>
<ul class="simple">
<li><p>K-NN with biases (<span class="math notranslate nohighlight">\(b_u\)</span> and <span class="math notranslate nohighlight">\(b_i\)</span> denote the bias term of user <span class="math notranslate nohighlight">\(u\)</span> and item <span class="math notranslate nohighlight">\(i\)</span>; they are predicted using <a class="reference external" href="https://surprise.readthedocs.io/en/stable/prediction_algorithms.html#baselines-estimates-configuration">baseline estimation</a>):</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat{r}_{ui}=b_u+b_i+\frac{\sum s_{uv}(r_{vi}-b_u-b_i)}{\sum s_{uv}}\]</div>
</section>
<section id="id2">
<h4>Implementation: Lenskit<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<p>This section implements <a class="reference external" href="https://lkpy.readthedocs.io/en/stable/knn.html">Lenskit’s K-NN Collaborative Filtering</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">dfRatingBase</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">})</span>
<span class="n">dfRatingBase</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kni</span> <span class="o">=</span> <span class="n">ItemItem</span><span class="p">(</span><span class="n">nnbrs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">kni</span> <span class="o">=</span> <span class="n">Recommender</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">kni</span><span class="p">)</span> <span class="c1"># ensure the object to be a Recommender</span>
<span class="n">kni</span> <span class="o">=</span> <span class="n">kni</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfRatingBase</span><span class="p">)</span> <span class="c1"># input columns specified by name: &quot;user&quot;, &quot;item&quot; and &quot;rating&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_test.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">dfRatingTest</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">})</span>

<span class="n">dfPredict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">kni</span><span class="p">,</span> <span class="n">dfRatingTest</span><span class="p">)</span>
<span class="n">dfPredict</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">prediction</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">dfPredict</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>20</td>
      <td>4</td>
      <td>3.946739</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>33</td>
      <td>4</td>
      <td>3.725074</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>61</td>
      <td>4</td>
      <td>4.284423</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>117</td>
      <td>3</td>
      <td>3.587154</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>155</td>
      <td>2</td>
      <td>2.811777</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kni</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">item_means_</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1680,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">rating</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">prediction</span>

<span class="n">r2_test</span> <span class="o">=</span> <span class="n">R2</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R2 = </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RMSE = </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 = 30.65%
RMSE = 0.9329
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>Implementation: Surprise<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h4>
<p>In this section we implement <a class="reference external" href="https://surprise.readthedocs.io/en/stable/knn_inspired.html">Surprise’s K-NN inspired algorithms</a>. The hyperparameters are:</p>
<ul class="simple">
<li><p>Aggregating strategy, using one of the classes
<code class="docutils literal notranslate"><span class="pre">KNNBasic</span></code>
<code class="docutils literal notranslate"><span class="pre">KNNWithMeans</span></code>
<code class="docutils literal notranslate"><span class="pre">KNNWithZScore</span></code>
<code class="docutils literal notranslate"><span class="pre">KNNBaseline</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">k</span></code>: the number of neighbors to consider (<span class="math notranslate nohighlight">\(k\)</span>), defaults to <em>40</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sim_options.user_base</span></code>: whether to use user-based or item-based approach, defaults to <em>True</em> (user-based).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sim_options.name</span></code>: the similarity metric, defaults to <em>msd</em> (mean squared difference). Other options are <em>cosine</em>, <em>pearson</em> and <em>pearson_baseline</em>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingTest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_test.csv&#39;</span><span class="p">)</span>
<span class="n">dfRatingBase</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the train set into Surprise&#39;s object</span>
<span class="n">dataTrain</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_from_df</span><span class="p">(</span><span class="n">dfRatingBase</span><span class="p">,</span> <span class="n">Reader</span><span class="p">())</span>
<span class="n">dataTrain</span> <span class="o">=</span> <span class="n">dataTrain</span><span class="o">.</span><span class="n">build_full_trainset</span><span class="p">()</span>

<span class="n">knn</span> <span class="o">=</span> <span class="n">KNNBasic</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_base&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;msd&#39;</span><span class="p">})</span>
<span class="n">knn</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataTrain</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing the msd similarity matrix...
Done computing similarity matrix.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_prediction</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">dfRatingTest</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">user_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">uid</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>
<span class="n">item_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">iid</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>
<span class="n">rating</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">r_ui</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">est</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_prediction</span><span class="p">]</span>

<span class="n">dfPredict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
    <span class="s1">&#39;item_id&#39;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">,</span>
    <span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span>
<span class="p">})</span>
<span class="n">dfPredict</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>rating</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>20</td>
      <td>4</td>
      <td>3.621755</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>33</td>
      <td>4</td>
      <td>3.663870</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>61</td>
      <td>4</td>
      <td>4.083298</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>117</td>
      <td>3</td>
      <td>3.551694</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>155</td>
      <td>2</td>
      <td>2.832823</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">rating</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">dfPredict</span><span class="o">.</span><span class="n">prediction</span>

<span class="n">r2_test</span> <span class="o">=</span> <span class="n">R2</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R2 = </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RMSE = </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 = 21.10%
RMSE = 0.9950
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="other-methods">
<h2>3. Other methods<a class="headerlink" href="#other-methods" title="Permalink to this headline">#</a></h2>
<section id="content-filtering">
<h3>3.1. Content Filtering<a class="headerlink" href="#content-filtering" title="Permalink to this headline">#</a></h3>
<p>The main idea of this approach is to calculate the similarity score between each user - item pair. This is achieved by building vectors for each item and user. Here are the steps involved in this approach:</p>
<ul class="simple">
<li><p>Gather metadata for building item features. Item features must be transformed to be numerical and must be on the same scale, this prevents some large features from dominating the similarity calculation. A fair way of scaling is to select a scale factor for each feature equals to the inverse of the average.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{x}\leftarrow\frac{1}{\mu_{\mathbf{x}}}\mathbf{x}\]</div>
<ul class="simple">
<li><p>Center the preference vectors by subtracting each value with the corresponding user’s average rating. The purpose of doing this is to remove any bias from user’s explicit ratings. For example, a movie critic tends to give a movie a lower rating score than normal, he seems to not like most of the movies. Thanks to the centering technique, above-average rating movies show up and are considered to be positively rated.</p></li>
<li><p>Build user profiles from their ratings and item features. A user profile demonstrates the ratings he/she gives to each of the item characteristics.</p></li>
</ul>
<p>In a content-based system, we take metadata of items and the utility matrix as input. If the utility matrix is made using explicit ratings, we <em>center</em> it by subtracting the mean ratings of users.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRatingBase</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/rating_base.csv&#39;</span><span class="p">)</span>

<span class="n">dfRatingMean</span> <span class="o">=</span> <span class="n">dfRatingBase</span>\
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">})</span>\
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;rating_mean&#39;</span><span class="p">})</span>

<span class="n">dfRatingNorm</span> <span class="o">=</span> <span class="n">dfRatingBase</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfRatingMean</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">dfRatingNorm</span> <span class="o">=</span> <span class="n">dfRatingNorm</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;rating_norm = rating - rating_mean&#39;</span><span class="p">)</span>
<span class="n">dfRatingNorm</span> <span class="o">=</span> <span class="n">dfRatingNorm</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;rating_mean&#39;</span><span class="p">])</span>
<span class="n">dfRatingNorm</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>rating_norm</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.40</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>-0.60</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>0.40</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>-0.60</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>-0.60</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfItem</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/item.csv&#39;</span><span class="p">)</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;movie_title&#39;</span><span class="p">)</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;release_year&#39;</span><span class="p">:</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">release_year</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]})</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dfItem</span><span class="o">.</span><span class="n">release_year</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">release_year</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_features</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">dfUserProfile</span> <span class="o">=</span> <span class="n">dfRatingNorm</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfItem</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item_features</span><span class="p">:</span>
    <span class="n">dfUserProfile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfUserProfile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfUserProfile</span><span class="p">[</span><span class="s1">&#39;rating_norm&#39;</span><span class="p">]</span>
<span class="n">dfUserProfile</span> <span class="o">=</span> <span class="n">dfUserProfile</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">item_features</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">dfUserProfile</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>release_year</th>
      <th>action</th>
      <th>adventure</th>
      <th>animation</th>
      <th>children</th>
      <th>comedy</th>
      <th>crime</th>
      <th>documentary</th>
      <th>drama</th>
      <th>fantasy</th>
      <th>noir</th>
      <th>horror</th>
      <th>musical</th>
      <th>mystery</th>
      <th>romance</th>
      <th>scifi</th>
      <th>thriller</th>
      <th>war</th>
      <th>western</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>-0.01</td>
      <td>-0.08</td>
      <td>-0.11</td>
      <td>-0.01</td>
      <td>-0.13</td>
      <td>-0.05</td>
      <td>-0.02</td>
      <td>0.02</td>
      <td>0.13</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>0.05</td>
      <td>0.06</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>-0.01</td>
      <td>0.05</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>0.07</td>
      <td>-0.01</td>
      <td>0.03</td>
      <td>-0.03</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.11</td>
      <td>-0.02</td>
      <td>-0.02</td>
      <td>-0.03</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>-0.00</td>
      <td>-0.03</td>
      <td>0.03</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.02</td>
      <td>0.06</td>
      <td>0.05</td>
      <td>0.13</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>-0.06</td>
      <td>-0.04</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.03</td>
      <td>-0.11</td>
      <td>0.03</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>0.01</td>
      <td>-0.30</td>
      <td>-0.29</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.09</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>0.14</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.05</td>
      <td>-0.01</td>
      <td>-0.10</td>
      <td>-0.15</td>
      <td>-0.15</td>
      <td>-0.03</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>-0.03</td>
      <td>0.08</td>
      <td>0.08</td>
      <td>0.07</td>
      <td>-0.08</td>
      <td>0.05</td>
      <td>0.05</td>
      <td>0.00</td>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.05</td>
      <td>0.03</td>
      <td>0.00</td>
      <td>-0.07</td>
      <td>0.12</td>
      <td>-0.00</td>
      <td>0.04</td>
      <td>-0.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">dfUserProfile</span><span class="p">[</span><span class="n">item_features</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">dfItem</span><span class="p">[</span><span class="n">item_features</span><span class="p">]</span>
<span class="n">similar_matrix</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

<span class="n">dfSimilar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">similar_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dfUserProfile</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">dfItem</span><span class="o">.</span><span class="n">movie_id</span><span class="p">)</span>
<span class="n">dfSimilar</span> <span class="o">=</span> <span class="n">dfSimilar</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">dfSimilar</span> <span class="o">=</span> <span class="n">dfSimilar</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dfSimilar</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>1673</th>
      <th>1674</th>
      <th>1675</th>
      <th>1676</th>
      <th>1677</th>
      <th>1678</th>
      <th>1679</th>
      <th>1680</th>
      <th>1681</th>
      <th>1682</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>-0.42</td>
      <td>-0.38</td>
      <td>-0.02</td>
      <td>-0.03</td>
      <td>0.21</td>
      <td>0.34</td>
      <td>0.42</td>
      <td>-0.14</td>
      <td>0.34</td>
      <td>...</td>
      <td>-0.20</td>
      <td>0.43</td>
      <td>0.34</td>
      <td>0.34</td>
      <td>0.34</td>
      <td>0.33</td>
      <td>0.11</td>
      <td>0.40</td>
      <td>-0.18</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>0.03</td>
      <td>0.10</td>
      <td>-0.15</td>
      <td>0.44</td>
      <td>0.19</td>
      <td>0.29</td>
      <td>0.15</td>
      <td>0.25</td>
      <td>0.29</td>
      <td>...</td>
      <td>0.08</td>
      <td>0.38</td>
      <td>0.29</td>
      <td>0.29</td>
      <td>0.29</td>
      <td>0.29</td>
      <td>0.27</td>
      <td>0.63</td>
      <td>0.05</td>
      <td>0.29</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>0.04</td>
      <td>-0.25</td>
      <td>-0.36</td>
      <td>0.29</td>
      <td>0.21</td>
      <td>0.45</td>
      <td>0.28</td>
      <td>0.36</td>
      <td>0.45</td>
      <td>...</td>
      <td>-0.37</td>
      <td>0.55</td>
      <td>0.44</td>
      <td>0.44</td>
      <td>0.44</td>
      <td>0.44</td>
      <td>-0.27</td>
      <td>0.38</td>
      <td>0.06</td>
      <td>0.44</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>0.10</td>
      <td>-0.72</td>
      <td>-0.20</td>
      <td>-0.05</td>
      <td>0.06</td>
      <td>0.21</td>
      <td>0.00</td>
      <td>0.24</td>
      <td>0.21</td>
      <td>...</td>
      <td>-0.50</td>
      <td>0.25</td>
      <td>0.21</td>
      <td>0.21</td>
      <td>0.21</td>
      <td>0.21</td>
      <td>-0.27</td>
      <td>0.06</td>
      <td>0.15</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>0.01</td>
      <td>0.27</td>
      <td>-0.11</td>
      <td>0.15</td>
      <td>-0.04</td>
      <td>-0.19</td>
      <td>0.15</td>
      <td>-0.20</td>
      <td>-0.19</td>
      <td>...</td>
      <td>0.12</td>
      <td>-0.17</td>
      <td>-0.19</td>
      <td>-0.19</td>
      <td>-0.19</td>
      <td>-0.19</td>
      <td>-0.26</td>
      <td>-0.32</td>
      <td>0.05</td>
      <td>-0.19</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 1683 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thres</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dfRelavent</span> <span class="o">=</span> <span class="n">dfSimilar</span>\
    <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;score&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;score &gt;= @thres&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfRatingBase</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;rating.isna()&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">])</span>
<span class="n">dfRelavent</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>1</td>
      <td>0.04</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>1</td>
      <td>0.10</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>1</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9</td>
      <td>1</td>
      <td>0.04</td>
    </tr>
    <tr>
      <th>5</th>
      <td>12</td>
      <td>1</td>
      <td>0.20</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfRecommend</span> <span class="o">=</span> <span class="n">dfRelavent</span>\
    <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">movie_id</span>\
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;recommend&#39;</span><span class="p">)</span>
<span class="n">dfRecommend</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>recommend</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>[1542, 617, 429, 1397, 1299]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>[1299, 1050, 131, 207, 197]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>[1122, 1453, 1542, 617, 1397]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>[1456, 1614, 481, 1104, 523]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>[271, 82, 897, 636, 1411]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">935</span><span class="p">)</span>

<span class="n">recommend</span> <span class="o">=</span> <span class="n">dfRecommend</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;user_id==@user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">recommend</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">dfUserProfile</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;user_id==@user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">})</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;movie_id.isin(@recommend)&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">})</span>
<span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>release_year</th>
      <th>action</th>
      <th>adventure</th>
      <th>animation</th>
      <th>children</th>
      <th>comedy</th>
      <th>crime</th>
      <th>documentary</th>
      <th>drama</th>
      <th>fantasy</th>
      <th>noir</th>
      <th>horror</th>
      <th>musical</th>
      <th>mystery</th>
      <th>romance</th>
      <th>scifi</th>
      <th>thriller</th>
      <th>war</th>
      <th>western</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>696</th>
      <td>697</td>
      <td>-0.01</td>
      <td>-0.03</td>
      <td>-0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.03</td>
      <td>-0.03</td>
      <td>0.11</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>-0.04</td>
      <td>-0.00</td>
      <td>0.03</td>
      <td>0.12</td>
      <td>0.04</td>
      <td>-0.05</td>
      <td>0.03</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>130</th>
      <td>131</td>
      <td>0.51</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>132</th>
      <td>133</td>
      <td>0.22</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>482</th>
      <td>483</td>
      <td>0.26</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>1049</th>
      <td>1050</td>
      <td>0.33</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>1298</th>
      <td>1299</td>
      <td>0.25</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="demographic-filtering">
<h3>3.2. Demographic Filtering<a class="headerlink" href="#demographic-filtering" title="Permalink to this headline">#</a></h3>
</section>
<section id="regression-approach">
<h3>3.3. Regression approach<a class="headerlink" href="#regression-approach" title="Permalink to this headline">#</a></h3>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfUser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/user.csv&#39;</span><span class="p">)</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">dfUser</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">])</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">dfUser</span><span class="o">.</span><span class="n">sex</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">dfUser</span><span class="o">.</span><span class="n">occupation</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dfUserProfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dfUserProfile</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>age</th>
      <th>M</th>
      <th>artist</th>
      <th>doctor</th>
      <th>educator</th>
      <th>engineer</th>
      <th>entertainment</th>
      <th>executive</th>
      <th>healthcare</th>
      <th>...</th>
      <th>marketing</th>
      <th>none</th>
      <th>other</th>
      <th>programmer</th>
      <th>retired</th>
      <th>salesman</th>
      <th>scientist</th>
      <th>student</th>
      <th>technician</th>
      <th>writer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>24</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>53</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>23</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>24</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>33</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfItem</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/movielens/item.csv&#39;</span><span class="p">)</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;movie_title&#39;</span><span class="p">)</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;release_year&#39;</span><span class="p">:</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">release_year</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]})</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dfItem</span><span class="o">.</span><span class="n">release_year</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">dfItem</span> <span class="o">=</span> <span class="n">dfItem</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">release_year</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfTrain</span> <span class="o">=</span> <span class="n">dfRatingBase</span>\
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfUserProfile</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfItem</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;movie_id&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">])</span>

<span class="n">dfTest</span> <span class="o">=</span> <span class="n">dfRatingTest</span>\
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfUserProfile</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfItem</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;movie_id&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">])</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">dfTrain</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">dfTest</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">dfTrain</span><span class="o">.</span><span class="n">rating</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">dfTest</span><span class="o">.</span><span class="n">rating</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">],</span>
    <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">],</span>
    <span class="s1">&#39;max_samples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">params</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">r2_test</span> <span class="o">=</span> <span class="n">R2</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R2 = </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RMSE = </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 = 13.90%
RMSE = 1.0394
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(9430, 41)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(9430,)
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "hungpq7/tabular-book",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./06-machine-learning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="sklearn-feature-engineering.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Sklearn: Feature Engineering</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="pyspark-machine-learning.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">PySpark: Machine Learning</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Quang Hung &#9829; Thuy Linh<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>